
/* SKELETON for env functions */
/* Program generated by Cadvanced 4.3.0.0.14276 */
#define XSCT_CADVANCED

#define XUSE_SIGNAL_NUMBERS

#ifndef XENV
#define XENV
#endif

#define DB_FAILURE_EXIT_CODE 0
#define BPM_FAILURE_EXIT_CODE 1
#define FRMWRK_FAILURE_EXIT_CODE 2
#define GETINST_FAILURE_EXIT_CODE 3

#define C_TRANSLATOR_4_1
#include "scttypes.h"
#ifdef XUSE_SIGNAL_NUMBERS
#include "SystemClassPsscm.hs"
#endif
#ifdef XENV_INC
#include XENV_INC
#endif
#include "SystemClassPsscm.ifc"

#define SELF_ENTITY_NAME "PSSCM" 
#include<pthread.h>
#include "bpmxxx_platformLib.h"
#include "bpmxxx_OAM_commonDef.h"
#include "bpmxxx_commonDef.h"
#include "oamspsscm_hashdefs.h"
#include "dbsxxx_commonwrappers.h"
#include "oamsxxx_semaphore.h" 
#include "oams_sig_handler.h" 

I_S32 gCurrentCardState = CARDSTATE_INIT;
I_S32 gNewCardState = BSC_APP_CARDSTATE_INVALID;
I_U32 gInstancesCreated = I_FALSE;
I_S32 gSignalSent = 0;
I_U16 gInstCount = 0;
sem_t gSemHandler;

I_U32 gLclPidPsscmActiveClass = INVALID_LCL_PID_PTR ;
I_U32 gLclPidSystemClass = INVALID_LCL_PID_PTR ;
I_U16 frChannel = INVALID_IU16;
I_U32 dlci= INVALID_IU32;
I_S32 dbResult;
I_S32 selfEntIdG = (int)ENT_OAMS_PSSCM;


#ifndef XNOGLOBALNODENUMBER
/*---+---------------------------------------------------------------
  xGlobalNodeNumber  extern
  -------------------------------------------------------------------*/
#ifndef XENV_NODENUMBER
#define XENV_NODENUMBER return 1;
#endif

extern int xGlobalNodeNumber(void)
{
   /* Assign a unique global system Id to each SDL system in a cluster of systems. */
   return ENT_OAMS_PSSCM;
}
#endif



/** 
 * Interface with Base Platform Module (BPM)
 * Note1: BPM is an optional feature in the system.
 * All code pertaining to BPM interface should be under a compile time
 * flag.
 */

#if BPM_PRESENT != 1

#define RegisterPsscmWithBpm() bpmGetComponentReg(ENT_OAMS_PSSCM_STUB,&PsscmBpmCallbackFunc); 
/* Changes for HA Start */
#define bpmRespondToAis(a,b)
/* Changes for HA End */
#warning "BPM support not compiled"

#else

void PsscmBpmCallbackFunc (struct sAisParam *param);
void RegisterPsscmWithBpm(void)
{
   bpmGetComponentRegister (PsscmBpmCallbackFunc, APPID_OAMS_PSSCM);
   bpmComponentConfigure ();
}

#endif
/* BPM_PRESENT */
/********************************************************************/
/* Changes for HA Start */

I_U32 sendCntxtDataToModel()
{
  LOG_PRINT(DEBUG,"in func sendCntxtDataToModel");
  xSignalNode     S;
  SDL_Pid         rcvr;
  I_U32           lclPidPtr = INVALID_LCL_PID_PTR ;
  I_S32           instId = ZERO;
  I_U16           instCount = ZERO;
  rcvr.GlobalNodeNr = (I_S32)selfEntIdG;
  I_S32 dbCallResult;
  I_U32 numRows;
  I_U16 dataSize;
  PsscmCtxtTableApi *psscmCtxtbTable;
  PsscmRedCtxt *psscmRedCtxt;
  NsvchCtxtTableApi *nsvchCtxtbTable;
  NsvcRedCtxt *nsvchRedCtxt;
  I_U32 refId1,refId2;
  I_S32           index;
  /* Changes for HotStb start here     */
  //read db for context
  //getall new instance as the data is  
  dbCallResult = getallPsscmCtxtTable(&(psscmCtxtbTable),&(numRows),&(dataSize));
  if (dbCallResult != DBLIB_SUCCESS)
  {
    LOG_PRINT(CRITICAL,"Failed: db call for PsscmCtxtTable, error code = [%d]",dbCallResult);
    return BSS_FAILURE; 
  }
  else
  {
    LOG_PRINT(DEBUG,"db call for PsssmCtxtTable success");
    //send message allocate new instances 
    for(instCount=0;instCount<numRows;instCount++)
    {
      psscmRedCtxt = AlocOrdBuf(sizeof(PsscmRedCtxt));
      memcpy(psscmRedCtxt, (PsscmCtxtTableApi *)( psscmCtxtbTable + sizeof(PsscmCtxtTableApi)*instCount),sizeof(PsscmRedCtxt));   

      LOG_PRINT(INFO,"(BPM)Sending signal PSSCM_INT_STANDBY_TO_AIP to Model");
      //  send the data and move to the state 
      rcvr.LocalPId = (xLocalPIdNode)gLclPidPsscmActiveClass; 
     LOG_PRINT(INFO,"psscmRedCtxt->gbIfIndex  = %d ",psscmRedCtxt->gbIfIndex); 
     LOG_PRINT(INFO,"psscmRedCtxt->nsei  = %d ",psscmRedCtxt->nsei); 
     LOG_PRINT(INFO,"psscmRedCtxt->finalState  = %d ",psscmRedCtxt->finalState); 
     LOG_PRINT(INFO,"psscmRedCtxt->transportType  = %d ",psscmRedCtxt->transportType); 
     LOG_PRINT(INFO,"psscmRedCtxt->maxNsvcOverIp  = %d ",psscmRedCtxt->maxNsvcOverIp); 
     LOG_PRINT(INFO,"psscmRedCtxt->numOfNsvcEnabled  = %d ",psscmRedCtxt->numOfNsvcEnabled); 
     LOG_PRINT(INFO,"psscmRedCtxt->ongoingAction  = %d ",psscmRedCtxt->ongoingAction); 
      S = xGetSignal( sig_PSSCM_INT_STANDBY_TO_AIP, rcvr, xEnv);
      ((yPDP_sig_PSSCM_INT_STANDBY_TO_AIP)S)->Param1 = psscmRedCtxt; 
      SDL_Output( S xSigPrioPar(xDefaultPrioSignal), (xIdNode *)0 );
    }//end for loop 
    free(psscmCtxtbTable);
  }//else db call is success
  dbCallResult = getallNsvchCtxtTable(&(nsvchCtxtbTable),&(numRows),&(dataSize));
  if (dbCallResult != DBLIB_SUCCESS && dbCallResult==DBLIBERR_PTOPAGE_HAS_NO_ROWS)
  {
    LOG_PRINT(CRITICAL,"Failed: db call for NsvchCtxtTable, error code = [%d]",dbCallResult);
    return BSS_SUCCESS; 
  }
  if (dbCallResult != DBLIB_SUCCESS)
  {
    LOG_PRINT(CRITICAL,"Failed: db call for NsvchCtxtTable, error code = [%d]",dbCallResult);
    return BSS_FAILURE; 
  }
  else
  {
    LOG_PRINT(DEBUG,"db call for nsvchCtxtTable success");
    //send message allocate new instances 
    for(instCount=0;instCount<numRows;instCount++)
    {
      nsvchRedCtxt = AlocOrdBuf(sizeof(NsvcRedCtxt));
      memcpy(nsvchRedCtxt, (NsvchCtxtTableApi *)( nsvchCtxtbTable + sizeof(NsvchCtxtTableApi)*instCount),sizeof(NsvcRedCtxt));   
      refId1 = nsvchRedCtxt->nsvci ;
      refId2 = nsvchRedCtxt->frChannel ;
      // subject to change if IPC replicats the instance map. Then it will be for allocated instance ne lclpid ptr will be provided. Instead of allocatNewInstance it will be update lclpidptr for the instance Id 
      if (SearchAlocatedInst(&lclPidPtr,(I_S32*)&instId,ENT_OAMS_PSSCM,NSVCH_CLASS,refId1,refId2,0,0,0) != INST_SUCCESS)
      {
        if (AlocNewInst(&lclPidPtr,&instId,ENT_OAMS_PSSCM,NSVCH_CLASS,refId1,refId2,0,0,0) != INST_SUCCESS ) 
        {
          LOG_PRINT(CRITICAL,"(ENV:xInEnv)Unable to create New Instance...\n") ;
          free(nsvchCtxtbTable);
          DalocMsgBuf(nsvchRedCtxt);
          return BSS_FAILURE; 
        }
        if (0 == lclPidPtr)
        {
          LOG_PRINT(CRITICAL,"(ENV:xInEnv)Invalid Instance Found...\n");
          free(nsvchCtxtbTable);
          DalocMsgBuf(nsvchRedCtxt);
          return BSS_FAILURE; 
        }
      }
      //send the data and move to the state in the model
      /* Send this Message into TAU model */
      rcvr.LocalPId = (xLocalPIdNode)lclPidPtr;
      LOG_PRINT(INFO,"(BPM)Sending signal NSVCH_INT_STANDBY_TO_AIP to Model");
      S = xGetSignal( sig_NSVCH_INT_STANDBY_TO_AIP, rcvr, xEnv);
      ((yPDP_sig_NSVCH_INT_STANDBY_TO_AIP)S)->Param1 = nsvchRedCtxt;
      SDL_Output( S xSigPrioPar(xDefaultPrioSignal), (xIdNode *)0 );
    }//end for loop
    free(nsvchCtxtbTable);
  }//else db call is success       
  return BSS_SUCCESS; 
}
I_Void  updateCardStatus()
{
   gCurrentCardState = gNewCardState;
   gNewCardState = BSC_APP_CARDSTATE_INVALID;
}

I_U8* getCardStateNameStr(I_S32 cardState)
{
   I_U8 *pCardStateNameStr = "CARDSTATE_INVALID" ;
   switch(cardState)
   {
      case CARDSTATE_INIT:
         pCardStateNameStr = "CARDSTATE_INIT";
    break;
      case CARDSTATE_PLATFORM_INS:
         pCardStateNameStr = "CARDSTATE_PLATFORM_INS";
    break;
      case CARDSTATE_IN_SERVICE:
         pCardStateNameStr = "CARDSTATE_IN_SERVICE";
    break;
      case CARDSTATE_ACTIVE:
         pCardStateNameStr = "CARDSTATE_ACTIVE";
    break;
      case CARDSTATE_STANDBY:
         pCardStateNameStr = "CARDSTATE_STANDBY";
    break;
      case CARDSTATE_OUT_OF_SERVICE:
         pCardStateNameStr = "CARDSTATE_OUT_OF_SERVICE";
    break;
      case CARDSTATE_RECOVERY:
         pCardStateNameStr = "CARDSTATE_RECOVERY";
    break;
      case CARDSTATE_FAIL:
         pCardStateNameStr = "CARDSTATE_FAIL";
    break;
      case CARDSTATE_TEST:
         pCardStateNameStr = "CARDSTATE_TEST";
    break;
      case CARDSTATE_ABSENT:
         pCardStateNameStr = "CARDSTATE_ABSENT";
    break;
      case CARDSTATE_ACTIVE_IN_PROGRESS:
         pCardStateNameStr = "CARDSTATE_ACTIVE_IN_PROGRESS";
    break;
      case CARDSTATE_UPGRADE:
         pCardStateNameStr = "CARDSTATE_UPGRADE";
    break;
      case CARDSTATE_RESTART:
         pCardStateNameStr = "CARD_RESTART";
    break;
      default:
    break;
   }
   return (pCardStateNameStr);
}


I_Void cardStateChangeHandler(struct sAisParam *param)
{
  xSignalNode     S;
  SDL_Pid         rcvr;
  I_U32           lclPidPtr = INVALID_LCL_PID_PTR ;
  I_S32           result = ZERO;
  I_Bool          signalSentToModel = I_FALSE;
  I_S32           instId;
  I_U16           instCount = ZERO;
  I_S8            instCountResult = ZERO;

  GbInterfaceTableApi *pGbInterfaceTable = NULL;
  I_U16 dbSize;
  I_U16 transportType;
  I_U32 dbCount;
  I_S32 dbResult;
  rcvr.GlobalNodeNr = (I_S32)selfEntIdG;
  rcvr.LocalPId = (xLocalPIdNode)0;
  LOG_PRINT(INFO,"(BPM)BPM_SELFCARD_STATE_CHANGE received. Current State=[%s], Received State=[%s]",getCardStateNameStr(gCurrentCardState),getCardStateNameStr(param->cardState)) ;


  /* INIT -> INSERVICE */
  if ( (param->cardState == CARDSTATE_IN_SERVICE) && (gCurrentCardState == CARDSTATE_INIT) )
  {
    gNewCardState = CARDSTATE_IN_SERVICE;
    LOG_PRINT(DEBUG,"(BPM)Registering with DB Server...");
    result = dbConnect();
    if ( result != DBLIB_SUCCESS )
    {
      LOG_PRINT(CRITICAL,"BPM: Unable to Register itself with DBServer:Exiting");
      exit(DB_FAILURE_EXIT_CODE);
    }
    LOG_PRINT(DEBUG,"(BPM)Successfully Registered with DB Server.");
    /* Changes for HotStb start here     */
    if(gInstancesCreated == I_FALSE)
    {
      LOG_PRINT(INFO,"(BPM)No instances found in TauInst table so sending signal to Model to create instances");
      LOG_PRINT(INFO,"(BPM)Initializing Inst Map Table...\n");
      InitInstMap(ENT_OAMS_PSSCM,NSVCH_CLASS);
      result = GetInstCount(ENT_OAMS_PSSCM, NSVCH_CLASS , &instCount);
      if(result != INST_SUCCESS)
      {
        LOG_PRINT(MAJOR,"(BPM)GetInstCount Db call failed... ");
        updateCardStatus();
        LOG_PRINT(INFO,"(BPM)Moving from INIT to INSERVICE.. ");
        LOG_PRINT(INFO,"(BPM)Releasing semaphore.. ");
        SEM_POST(&gSemHandler);
        exit(DB_FAILURE_EXIT_CODE);
      }
      else if(ZERO == instCount)
      {
        LOG_PRINT(MAJOR,"(BPM): Nsvch inst count in db is ZERO...... ");
        updateCardStatus();
        LOG_PRINT(INFO,"(BPM)Moving from INIT to INSERVICE.. ");
        LOG_PRINT(INFO,"(BPM)Releasing semaphore.. ");
        SEM_POST(&gSemHandler);
        exit(DB_FAILURE_EXIT_CODE);
      }
      else
      {
        gInstCount = instCount;
        S = xGetSignal( sig_NSVCH_INT_ADD_TAU_INSTANCE, xNotDefPId, xEnv);
        SDL_Output( S xSigPrioPar(xDefaultPrioSignal), (xIdNode *)0 );
      }

    }
    /* Changes for HotStb end here     */
    // LOG_PRINT(INFO,"(BPM)Moving from INIT to INSERVICE.. ");

    // updateCardStatus();
    // LOG_PRINT(INFO,"(BPM)Releasing semaphore.. ");
    // SEM_POST(&gSemHandler);

  }

  /* ACTIVE -> INSERVICE*/
  else if ( (param->cardState == CARDSTATE_IN_SERVICE) && ( gCurrentCardState == CARDSTATE_ACTIVE) )
  {
    gNewCardState = CARDSTATE_IN_SERVICE;

    instCountResult = GetInstCount(ENT_OAMS_PSSCM, NSVCH_CLASS , &instCount);
    if ( instCountResult != INST_SUCCESS )
    {
      LOG_PRINT(MAJOR,"[BPM] GetInstCount Db call failed.. ");
      instCount = 0 ;
    }
    for ( instId = 1; instId <= instCount; instId ++ )
    {
      GetLclPidFrmInstId( &lclPidPtr, instId, (I_U8)ENT_OAMS_PSSCM , NSVCH_CLASS);
      LOG_PRINT(DEBUG,"(BPM)GetLclPidFrmInstId Success lclPid = 0x%x",(I_U32)lclPidPtr);
      if (lclPidPtr != INVALID_LCL_PID_PTR )
      {
        rcvr.LocalPId = (xLocalPIdNode)lclPidPtr;
        LOG_PRINT(INFO,"(BPM)Sending signal NSVCH_INT_SELFCARD_STATE_CHANGE to Model");
        S = xGetSignal( sig_NSVCH_INT_SELFCARD_STATE_CHANGE, rcvr, xEnv);
        SDL_Output( S xSigPrioPar(xDefaultPrioSignal), (xIdNode *)0 );
        gSignalSent ++;
      }
    }
    rcvr.LocalPId = (xLocalPIdNode)gLclPidPsscmActiveClass;
    LOG_PRINT(INFO,"(BPM)Sending signal PSSCM_INT_SELFCARD_STATE_CHANGE to Model");
    S = xGetSignal( sig_PSSCM_INT_SELFCARD_STATE_CHANGE, rcvr, xEnv);
    SDL_Output( S xSigPrioPar(xDefaultPrioSignal), (xIdNode *)0 );
    gSignalSent ++;

    LOG_PRINT(INFO,"Moving from ACTIVE to INSERVICE.. ");
  }

  /* INSERVICE -> STANDBY*/
  else if ( (param->cardState == CARDSTATE_STANDBY) && (gCurrentCardState == CARDSTATE_IN_SERVICE) )
  {
    gNewCardState = CARDSTATE_STANDBY;
    updateCardStatus();
    LOG_PRINT(INFO,"(BPM)Moving from INSERVICE to STANDBY.. ");
    LOG_PRINT(INFO,"(BPM)Releasing semaphore.. ");
    SEM_POST(&gSemHandler);

  }

  /* INSERVICE -> ACTIVEINPROGRESS*/
  else if ( (param->cardState == CARDSTATE_ACTIVE_IN_PROGRESS) && (  gCurrentCardState == CARDSTATE_IN_SERVICE ))
  {
    gNewCardState = CARDSTATE_ACTIVE_IN_PROGRESS;
    updateCardStatus();
    LOG_PRINT(INFO,"(BPM)Moving from INSERVICE to ACTIVEINPROGRESS.. ");
    LOG_PRINT(INFO,"(BPM)Releasing semaphore.. ");
    SEM_POST(&gSemHandler);

  }
  /* STANDBY -> ACTIVEINPROGRESS*/
  else if ( (param->cardState == CARDSTATE_ACTIVE_IN_PROGRESS) && (gCurrentCardState == CARDSTATE_STANDBY ) )
  {
    /* Changes for HotStb start here     */

    dbResult = getallGbInterfaceTable(&pGbInterfaceTable,&dbCount,&dbSize);
    if(CLIB_SUCCESS == dbResult)
    {
      transportType = pGbInterfaceTable->transportType;
      LOG_PRINT(DEBUG, "(PSSCM):  transportType value received from DB : %d", transportType);
      free(pGbInterfaceTable);
    }
    else
    {
      LOG_PRINT(MAJOR, "(PSSCM): DB call getallGbInterfaceTable failed..   ");
      LOG_PRINT(INFO, "(PSSCM): Exiting Function initialization.. ");
    } 
    if (PCU_GB_TRANSPORT_TYPE_FR == transportType)
    {
      //do nothing 
    }
    else{
    /* do this for PSSCM     */
    sendCntxtDataToModel();
    }
    /* Changes for HotStb end here     */
    gNewCardState = CARDSTATE_ACTIVE_IN_PROGRESS;
    updateCardStatus();
    LOG_PRINT(INFO,"(BPM)Moving from STANDBY to ACTIVEINPROGRESS.. ");
    LOG_PRINT(INFO,"(BPM)Releasing semaphore.. ");
    SEM_POST(&gSemHandler);

  }

  /* ACTIVEINPROGRESS -> ACTIVE */
  else if ( (param->cardState == CARDSTATE_ACTIVE) && (gCurrentCardState == CARDSTATE_ACTIVE_IN_PROGRESS) )
  {
    gNewCardState = CARDSTATE_ACTIVE;
    updateCardStatus();
    LOG_PRINT(INFO,"(BPM)Moving from ACTIVEINPROGRESS to ACTIVE.. ");
    LOG_PRINT(INFO,"(BPM)Releasing semaphore.. ");
    SEM_POST(&gSemHandler);
  }
  /* STANDBY -> RECOVERY */
  else if ( (param->cardState == CARDSTATE_RECOVERY) && (gCurrentCardState == CARDSTATE_STANDBY) )
  {
    gNewCardState = CARDSTATE_RECOVERY;
    updateCardStatus();
    LOG_PRINT(INFO,"(BPM)Moving from STANDBY to RECOVERY.. ");
    LOG_PRINT(INFO,"(BPM)Releasing semaphore.. ");
    SEM_POST(&gSemHandler);

  }

  /* STANDBY -> OUTOFSERVICE */
  else if ( (param->cardState == CARDSTATE_OUT_OF_SERVICE) && (gCurrentCardState == CARDSTATE_STANDBY) )
  {
    gNewCardState = CARDSTATE_OUT_OF_SERVICE;
    updateCardStatus();
    LOG_PRINT(INFO,"(BPM)Moving from STANDBY to OUTOFSERVICE.. ");
    LOG_PRINT(INFO,"(BPM)Releasing semaphore.. ");
    SEM_POST(&gSemHandler);
  }


  /* ACTIVE -> RECOVERY */
  else if ( (param->cardState == CARDSTATE_RECOVERY) && (gCurrentCardState == CARDSTATE_ACTIVE) )
  {
    gNewCardState = CARDSTATE_RECOVERY;
    instCountResult = GetInstCount(ENT_OAMS_PSSCM, NSVCH_CLASS , &instCount);
    if ( instCountResult != INST_SUCCESS )
    {
      LOG_PRINT(MAJOR,"[ENV] GetInstCount Db call failed.. ");
      return;
    }
    for ( instId = 1; instId <= instCount; instId ++ )
    {
      GetLclPidFrmInstId( &lclPidPtr, instId, (I_U8)ENT_OAMS_PSSCM ,NSVCH_CLASS);
      LOG_PRINT(DEBUG,"GetLclPidFrmInstId Success lclPid = 0x%x",(I_U32)lclPidPtr);
      if (lclPidPtr != INVALID_LCL_PID_PTR )
      {
        rcvr.LocalPId = (xLocalPIdNode)lclPidPtr;
        LOG_PRINT(INFO,"Sending signal NSVCH_INT_SELFCARD_STATE_CHANGE to Model");
        S = xGetSignal( sig_NSVCH_INT_SELFCARD_STATE_CHANGE, rcvr, xEnv);
        SDL_Output( S xSigPrioPar(xDefaultPrioSignal), (xIdNode *)0 );
        gSignalSent ++;
      }
    }
    rcvr.LocalPId = (xLocalPIdNode)gLclPidPsscmActiveClass;
    LOG_PRINT(INFO,"(BPM)Sending signal PSSCM_INT_SELFCARD_STATE_CHANGE to Model");
    S = xGetSignal( sig_PSSCM_INT_SELFCARD_STATE_CHANGE, rcvr, xEnv);
    SDL_Output( S xSigPrioPar(xDefaultPrioSignal), (xIdNode *)0 );
    gSignalSent ++;

  }
  /* RECOVERY -> INSERVICE */
  else if ( (param->cardState == CARDSTATE_IN_SERVICE) && (gCurrentCardState == CARDSTATE_RECOVERY) )
  {
    gNewCardState = CARDSTATE_IN_SERVICE;
    /* DeRegister with DB */
    if ((result = dbDestroy()) != DBLIB_SUCCESS)
    {
      LOG_PRINT(MAJOR,"(BPM)dbDestroy failed for PSSCM (Error = %d)",result);
      exit(DB_FAILURE_EXIT_CODE);

    }

    LOG_PRINT(DEBUG,"(BPM)Registering with DB Server...");
    result = dbConnect();
    if ( result != DBLIB_SUCCESS )
    {
      LOG_PRINT(CRITICAL,"(BPM) Unable to Register itself with DBServer:Exiting");
      exit(DB_FAILURE_EXIT_CODE);

    }
    LOG_PRINT(DEBUG,"(BPM)Successfully Registered with DB Server.");
    updateCardStatus();
    LOG_PRINT(INFO,"(BPM)Moving from RECOVERY to INSERVICE.. ");
    LOG_PRINT(INFO,"(BPM)Releasing semaphore.. ");
    SEM_POST(&gSemHandler);

  }
  /* OUTOFSERVICE -> INSERVICE */
  else if ( (param->cardState == CARDSTATE_IN_SERVICE) && (gCurrentCardState == CARDSTATE_OUT_OF_SERVICE) )
  {
    gNewCardState = CARDSTATE_IN_SERVICE;
    /* DeRegister with DB */
    if ((result = dbDestroy()) != DBLIB_SUCCESS)
    {
      LOG_PRINT(MAJOR,"(BPM)dbDestroy failed for Module (Error = %d)",result);
      /* Need to re-confirm what to do in such case */
    }

    LOG_PRINT(DEBUG,"(BPM)Registering with DB Server...");
    result = dbConnect();
    if ( result != DBLIB_SUCCESS )
    {
      LOG_PRINT(CRITICAL,"(BPM)Unable to Register itself with DBServer:Exiting");
      exit(DB_FAILURE_EXIT_CODE);
    }
    LOG_PRINT(DEBUG,"(BPM)Successfully Registered with DB Server.");
    updateCardStatus();
    LOG_PRINT(INFO,"(BPM)Moving from OUTOFSERVICE to INSERVICE.. ");
    LOG_PRINT(INFO,"(BPM)Releasing semaphore.. ");
    SEM_POST(&gSemHandler);
  }

  /* ACTIVE -> OUTOFSERVICE */
  else if ( (param->cardState == CARDSTATE_OUT_OF_SERVICE) && (gCurrentCardState == CARDSTATE_ACTIVE) )
  {
    gNewCardState = CARDSTATE_OUT_OF_SERVICE;
    instCountResult = GetInstCount(ENT_OAMS_PSSCM, NSVCH_CLASS , &instCount);
    if ( instCountResult != INST_SUCCESS )
    {
      LOG_PRINT(MAJOR,"(BPM)GetInstCount Db call failed.. ");
      instCount = 0 ;
    }
    for ( instId = 1; instId <= instCount; instId ++ )
    {
      GetLclPidFrmInstId( &lclPidPtr, instId, (I_U8)ENT_OAMS_PSSCM , NSVCH_CLASS);
      LOG_PRINT(DEBUG,"(BPM)findLclPidPtr Success lclPid = 0x%x",(I_U32)lclPidPtr);
      if (lclPidPtr != INVALID_LCL_PID_PTR )
      {
        rcvr.LocalPId = (xLocalPIdNode)lclPidPtr;
        LOG_PRINT(INFO,"(BPM)Sending signal NSVCH_INT_SELFCARD_STATE_CHANGE to Model");
        S = xGetSignal( sig_NSVCH_INT_SELFCARD_STATE_CHANGE, rcvr, xEnv);
        SDL_Output( S xSigPrioPar(xDefaultPrioSignal), (xIdNode *)0 );
        gSignalSent ++;
      }
    }
    rcvr.LocalPId = (xLocalPIdNode)gLclPidPsscmActiveClass;
    LOG_PRINT(INFO,"(BPM)Sending signal PSSCM_INT_SELFCARD_STATE_CHANGE to Model");
    S = xGetSignal( sig_PSSCM_INT_SELFCARD_STATE_CHANGE, rcvr, xEnv);
    SDL_Output( S xSigPrioPar(xDefaultPrioSignal), (xIdNode *)0 );
    gSignalSent ++;

  }   

  else
  {
    LOG_PRINT(INFO,"(BPM)cardStateChangeHandler: Unexpected state received  = %d",param->cardState) ;
    LOG_PRINT(INFO,"(BPM)Nothing to do...only releasing the semaphore") ;
    SEM_POST(&gSemHandler);

  }
}

void PsscmBpmCallbackFunc (struct sAisParam *param)
{
   switch (param->messageId)
   {
      case BPM_HEALTHCHECK_MESSAGE:
         bpmRespondToAis (param->invocation, OK);
         break;

      case BPM_SELFCARD_STATE_CHANGE:
                 LOG_PRINT(DEBUG,"(BPM)BPM_SELFCARD_STATE_CHANGE received ");
                 if( SEM_WAIT(&gSemHandler) !=0)
                    LOG_PRINT(DEBUG,"(BPM)SEM_WAIT failed ");
                 cardStateChangeHandler(param);
                 LOG_PRINT(DEBUG,"(BPM)Waiting for Semaphore...");
                 if( SEM_TIMED_WAIT(&gSemHandler) != SEMAPHORE_WAIT_COMPLETE)
                 {
                       LOG_PRINT(INFO,"(BPM)Got Sempahore.. ");
                       LOG_PRINT(INFO,"(BPM)calling bpmRespondToAis.. ");
                       bpmRespondToAis (param->invocation, OK);
                       LOG_PRINT(INFO,"(BPM)Response sent to BPM.. ");
                       LOG_PRINT(INFO,"(BPM)Releasing Sempahore.. ");
                       SEM_POST(&gSemHandler);
                 }
                 else
                 {
                       LOG_PRINT(INFO,"(BPM)SEMAPHORE Wait Timed Out... ");
                       LOG_PRINT(INFO,"(BPM)Releasing semaphore.. ");
                       SEM_POST(&gSemHandler);
                 }
                 break;
         

      case BPM_PEERCARD_STATE_CHANGE:
         LOG_PRINT(INFO, "(BPM)BPM_PEERCARD_STATE_CHANGE recd, No Action Taken");
         bpmRespondToAis (param->invocation, OK);
         break;

      case BPM_MSG_ACK_PEER_HEALTH_BAD:
         LOG_PRINT(INFO, "(BPM)BPM_MSG_ACK_PEER_HEALTH_BAD recd, Not Expected");
         break;
      case BPM_MSG_ACK_CONFIGURE:
         LOG_PRINT(INFO, "(BPM)BPM_MSG_ACK_CONFIGURE recd");
         break;
      case BPM_MSG_ACK_CONFIGURE_RESET:
         LOG_PRINT(INFO, "(BPM)BPM_MSG_ACK_CONFIGURE_RESET recd, No Action Taken");
         break;

      case BPM_SHUTDOWN:
         LOG_PRINT(INFO, "(BPM)BPM_SHUTDOWN recd, Exiting");
                 exit (BPM_FAILURE_EXIT_CODE);
         break;

      default:
         LOG_PRINT(MAJOR, "(BPM)Unexpected msg from BPM: %d", param->messageId);
         break;
   }
}

GetNsvchRefId(I_Void *rcvPtr ,I_U32 * refId1,I_U32 * refId2)
{
   /* Logic for getting the nsvci or fr channel from the Incoming Message*/

   SysHdr      *sysHdr ;
   I_U16       msgType ;
   sysHdr = (SysHdr *)rcvPtr ;
   msgType = sysHdr->msgType ;
   switch(msgType)
   {
      case OAMS_CFG_NSVCH_UNLOCK_REQ:
         *refId1 = ((OamsCfgNsvchUnlockReq *)rcvPtr)->nsvcId ;
         dbResult = getRowFromNsvcTable( *refId1 , &frChannel , &dlci);
         *refId2 = frChannel ;
         break ;
      case PSSKS_FR_NSVCH_N_STATUS_IND:
         *refId1 = 0 ;
         *refId2 = ((PssksFrNsvchNStatusInd *)rcvPtr)->frChannel  ;
         break ;
      case PSSKS_FR_NSVCH_N_CONN_IND:
         *refId1 = 0 ;
         *refId2 = ((PssksFrNsvchNConnInd *)rcvPtr)->frChannel ;
         break;
      case PSSKS_FR_NSVCH_N_DISC_IND:
         *refId1 = 0 ;
         *refId2 = ((PssksFrNsvchNDiscInd *)rcvPtr)->frChannel ;
         break ;

/* Start of Code changes for mantis 0014053*/
	  case PSSKS_FR_NSVCH_N_STOP_CNF:
         *refId1 = 0 ;
         *refId2 = ((PssksFrNsvchNStopCnf *)rcvPtr)->frChannel  ;
         break ;
/* End of Code changes for mantis 0014053 */

      case PSSKS_NS_NSVCH_PROV_FR_LINK_CNF:
         *refId1 = 0 ;
         *refId2 = ((PssksNsNsvchProvFrLinkCnf *)rcvPtr)->frChannel ;
         break;
      case PSSKS_NS_NSVCH_UNPROV_FR_LINK_CNF:
         *refId1 = 0 ;
         *refId2 = ((PssksNsNsvchUnprovFrLinkCnf *)rcvPtr)->frChannel ;
         break;
      case PSSKS_NS_NSVCH_PROV_NSVC_CNF:
         *refId1 = ((PssksNsNsvchProvNsvcCnf *)rcvPtr)->nsvci ;
         *refId2 = 0;
         break;
      case PSSKS_NS_NSVCH_UNPROV_NSVC_CNF:
         *refId1 = ((PssksNsNsvchUnprovNsvcCnf *)rcvPtr)->nsvci ;
         *refId2 = 0;
         break;
      case PSSKS_NS_NSVCH_ADD_NSVC_TO_NSEI_GRP_CNF:
         *refId1 = ((PssksNsNsvchAddNsvcToNseiGrpCnf *)rcvPtr)->nsvci ;
         *refId2 = 0;
         break;
      case PSSKS_NS_NSVCH_REM_NSVC_NSEI_GRP_CNF:
         *refId1 = ((PssksNsNsvchRemNsvcToNseiGrpCnf *)rcvPtr)->nsvci ;
         *refId2 = 0;
         break;
      case PSSKS_NS_NSVCH_NSVC_BLOCK_IND:
         *refId1 = ((PssksNsNsvchNsvcBlockInd *)rcvPtr)->nsvci ;
         *refId2 = 0;
         break;
      case PSSKS_NS_NSVCH_NSVC_DOWN_CNF:
         *refId1 = ((PssksNsNsvchNsvcDownCnf *)rcvPtr)->nsvci ;
         *refId2 = 0;
         break;
      case PSSKS_NS_NSVCH_NSVC_UNBLOCK_IND:
         *refId1 = ((PssksNsNsvchNsvcUnblockInd *)rcvPtr)->nsvci ;
         *refId2 = 0;
         break;
      case PSSKS_NS_NSVCH_NSVC_BLOCK_CNF:
         *refId1 = ((PssksNsNsvchNsvcBlockCnf *)rcvPtr)->nsvci ;
         *refId2 = 0;
         break;
      case PSSKS_NS_NSVCH_NSVC_UNBLOCK_CNF:
         *refId1 = ((PssksNsNsvchNsvcUnblockCnf *)rcvPtr)->nsvci ;
         *refId2 = 0;
         break;
      case PSSKS_NS_NSVCH_NSVC_RESET_CNF:
         *refId1 = ((PssksNsNsvchNsvcResetCnf *)rcvPtr)->nsvci ;
         *refId2 = 0;
         break;
      case PSSKS_NS_NSVCH_NSVC_RESET_IND:
         *refId1 = ((PssksNsNsvchNsvcResetInd *)rcvPtr)->nsvci ;
         *refId2 = 0;
         break;
      case PSSKS_NS_NSVCH_ALARM_IND:
         *refId1 = ((PssksNsNsvchAlarmInd *)rcvPtr)->key1 ;
         *refId2 = 0;
         break;
      case OAMS_CFG_NSVCH_LOCK_REQ:
         *refId1 = ((OamsCfgNsvchLockReq *)rcvPtr)->nsvcId ;
         *refId2 = 0;
         break;
      default:
         *refId1 = 0;
         *refId2 = 0;

   }
   return;
}

#ifndef XNOINITENV
/*---+---------------------------------------------------------------
  xInitEnv  extern
  -------------------------------------------------------------------*/
#ifndef XENV_INIT
#define XENV_INIT
#endif

extern void xInitEnv(void)
{
   /* Code to initialize your SDL-system environment may be inserted here */
   I_S32         result;
//#ifdef XTRACE
//	 xPrintString("(ENV:xInitEnv)xInitEnv called\n");
//#endif

/*#ifdef PLATFORM_IMR*/
#ifdef XTRACE
   xPrintString("(ENV:xInitEnv)Registering with BPM....\n");
#endif

   //RegisterPsscmWithBpm();CLOUD
/*#endif*/
#ifdef XTRACE
   xPrintString("(ENV:xInitEnv)Registering with IPC FramWork...\n");
#endif


   if (RegisterWithIpcFrmwrk(selfEntIdG, (I_S8 *)"ENT_OAMS_PSSCM") < 0)
   {
#ifdef XTRACE
            xPrintString("(ENV:xInitEnv)Unable to Register itself with IPC FrameWork : Exiting");
#endif
            exit(FRMWRK_FAILURE_EXIT_CODE) ;
   
   }
   RegisterPsscmWithBpm();
#ifdef XTRACE
   xPrintString("(ENV:xInitEnv)Registering with BPM....\n");
#endif

   LOG_PRINT(INFO,"(ENV:xInitEnv)CurrentCardState at initialization: [%d]", gCurrentCardState) ;
   LOG_PRINT(INFO,"(ENV:xInitEnv)NewCardState at initialization: [%d]", gNewCardState) ;
   SEM_INIT(&gSemHandler);
   LOG_PRINT(INFO, "(ENV:xInitEnv)Semaphore Initialized Successfully with pointer :: [%d]",&gSemHandler);

#ifndef PLATFORM_IMR
   LOG_PRINT(INFO,"(Env:XInitEnv):Registering with DB Server...\n");
   result = dbConnect();
   if (result != DBLIB_SUCCESS)
   {
     LOG_PRINT(CRITICAL,"(ENV:xInitEnv)Unable to register itself with DBServer:Exiting");
     exit(DB_FAILURE_EXIT_CODE) ;

   }
   LOG_PRINT(INFO,"(Env:xInitEnv)Successfully Registered with DB Server.\n");
   REGISTER_SIGNAL_HANDLER(); 
   LOG_PRINT(INFO,"xInitEnv: registered signal handler");
#endif

#ifdef XTRACE
   xPrintString("(ENV:xInitEnv)xInitEnv called\n");
#endif
}
#endif

#ifndef XNOCLOSEEnv
/*---+---------------------------------------------------------------
  xCloseEnv  extern
  -------------------------------------------------------------------*/
#ifndef XENV_CLOSE
#define XENV_CLOSE
#endif

extern void xCloseEnv(void)
{
   /* Code to bring down the environment in a controlled manner
      may be inserted here. */
   I_S32 retVal;

   /* DeRegister with DB */
   if ((retVal = dbDestroy()) != DBLIB_SUCCESS)
   {
      LOG_PRINT(MAJOR,"(ENV:xCloseEnv)dbDestroy failed for PSSCM (Error = %d)",retVal);
            exit(DB_FAILURE_EXIT_CODE);
      
   }/*if retVal */

#ifdef XTRACE
   xPrintString("(ENV:xCloseEnv)xCloseEnv called\n");
#endif
}
#endif


/*---+---------------------------------------------------------------
  Macros for xOutEnv
  -------------------------------------------------------------------*/
#ifndef OUT_LOCAL_VARIABLES
#define OUT_LOCAL_VARIABLES
#endif

#ifndef IF_OUT_SIGNAL
#define IF_OUT_SIGNAL(SIGNAL_NAME, SIGNAL_NAME_STRING) \
   if (((*SignalOut)->NameNode) == SIGNAL_NAME) {
#define END_IF_OUT_SIGNAL(SIGNAL_NAME, SIGNAL_NAME_STRING) \
   }
#endif

#ifndef OUT_SIGNAL1
#define OUT_SIGNAL1(SIGNAL_NAME, SIGNAL_NAME_STRING)
#endif

#ifndef OUT_SIGNAL2
#define OUT_SIGNAL2(SIGNAL_NAME, SIGNAL_NAME_STRING)
#endif

#ifndef XENV_ENC
#define XENV_ENC(stmt) stmt
#endif

#ifndef XENV_OUT_START
#define XENV_OUT_START
#endif

#ifndef RELEASE_SIGNAL
#define RELEASE_SIGNAL   xReleaseSignal(SignalOut); return;
#endif


/*---+---------------------------------------------------------------
  xOutEnv  extern
  -------------------------------------------------------------------*/
extern void xOutEnv( xSignalNode *SignalOut
#ifdef XPATH_INFO_IN_ENV_FUNC
      , xChannelIdNode Port
#endif
      )
{
   I_Void  *sndPtr     = NULL;
   I_S32   msgSize     = 0;
   I_U32   lclPidPtr   = INVALID_LCL_PID_PTR;
   I_S32   retVal      = 0;
   I_U16   msgType     = 0;
      static I_U8  recvdMsgs = 0;
#ifdef XTRACE
#ifdef XIDNAMES
   char  Temp[100];
   sprintf(Temp, "xOutEnv:  %s has been received by env\n",
         (*SignalOut)->NameNode->Name );
   xPrintString(Temp);
#else
   xPrintString("xOutEnv:  One signal has been received by env\n");
#endif
#endif
     if ( (gCurrentCardState != CARDSTATE_ACTIVE) && ((*SignalOut)->NameNode->SignalNumber != SN_PSSCM_INT_SELFCARD_STATE_CHANGE_RESP) && ((*SignalOut)->NameNode->SignalNumber != SN_OAMS_NSVCH_ADD_TAU_INST_IN_INSTMAP) && ((*SignalOut)->NameNode->SignalNumber != SN_SEND_PSSCM_PID_PTR) )
      {
            LOG_PRINT(INFO,"(ENV:xOutEnv)Current Card status is not Active. Discarding the Message\n");
            xReleaseSignal(SignalOut);
            return;
      }


   /* Signals going to the env via the port pPort */

   switch((*SignalOut)->NameNode->SignalNumber)
   {
      case SN_OAMS_PSSCM_CFG_UNLOCK_RESP:
         {
            LOG_PRINT(DEBUG,"(xOutEnv): Received SN_OAMS_PSSCM_CFG_UNLOCK_RESP from PSSCM");
            sndPtr = ((yPDP_sig_OAMS_PSSCM_CFG_UNLOCK_RESP)(*SignalOut))->Param1;
            msgSize = ((yPDP_sig_OAMS_PSSCM_CFG_UNLOCK_RESP)(*SignalOut))->Param2;
            if (sndPtr == NULL)
            {
               LOG_PRINT(MAJOR,"(xOutEnv):Received NULL pointer from Module, Returning without Sending to FRAMEWORK");
               xReleaseSignal(SignalOut);
               return ;
            }
            break;
         }

      case SN_OAMS_PSSCM_CFG_LOCK_RESP:
         {
            LOG_PRINT(DEBUG,"(xOutEnv): Received SN_OAMS_PSSCM_CFG_LOCK_RESP from PSSCM");
            sndPtr = ((yPDP_sig_OAMS_PSSCM_CFG_LOCK_RESP)(*SignalOut))->Param1;
            msgSize = ((yPDP_sig_OAMS_PSSCM_CFG_LOCK_RESP)(*SignalOut))->Param2;
            if (sndPtr == NULL)
            {
               LOG_PRINT(MAJOR,"(xOutEnv):Received NULL pointer from Module, Returning without Sending to FRAMEWORK");
               xReleaseSignal(SignalOut);
               return ;
            }
            break;
         }
      case SN_OAMS_PSSCM_CFG_ALARM_IND:
         {
            LOG_PRINT(DEBUG,"(xOutEnv): Received SN_OAMS_PSSCM_CFG_ALARM_IND from PSSCM");
            sndPtr = ((yPDP_sig_OAMS_PSSCM_CFG_ALARM_IND)(*SignalOut))->Param1;
            msgSize = ((yPDP_sig_OAMS_PSSCM_CFG_ALARM_IND)(*SignalOut))->Param2;
            if (sndPtr == NULL)
            {
               LOG_PRINT(MAJOR,"(xOutEnv):Received NULL pointer from Module, Returning without Sending to FRAMEWORK");
               xReleaseSignal(SignalOut);
               return ;
            }
            break;
         }

      case SN_OAMS_PSSCM_NS_PROV_SIG_BVC:
         {
            LOG_PRINT(DEBUG,"(xOutEnv): Received SN_OAMS_PSSCM_NS_PROV_SIG_BVC from PSSCM");
            sndPtr = ((yPDP_sig_OAMS_PSSCM_NS_PROV_SIG_BVC)(*SignalOut))->Param1;
            msgSize = ((yPDP_sig_OAMS_PSSCM_NS_PROV_SIG_BVC)(*SignalOut))->Param2;
            if (sndPtr == NULL)
            {
               LOG_PRINT(MAJOR,"(xOutEnv):Received NULL pointer from Module, Returning without Sending to FRAMEWORK");
               xReleaseSignal(SignalOut);
               return ;
            }
            break;
         }

      case SN_OAMS_PSSCM_NS_UNPROV_NSEI:
         {
            LOG_PRINT(DEBUG,"(xOutEnv): Received SN_OAMS_PSSCM_NS_UNPROV_NSEI from PSSCM");
            sndPtr = ((yPDP_sig_OAMS_PSSCM_NS_UNPROV_NSEI)(*SignalOut))->Param1;
            msgSize = ((yPDP_sig_OAMS_PSSCM_NS_UNPROV_NSEI)(*SignalOut))->Param2;
            if (sndPtr == NULL)
            {
               LOG_PRINT(MAJOR,"(xOutEnv):Received NULL pointer from Module, Returning without Sending to FRAMEWORK");
               xReleaseSignal(SignalOut);
               return ;
            }
            break;
         }

      case SN_OAMS_PSSCM_NS_PROV_NSEI:
         {
            LOG_PRINT(DEBUG,"(xOutEnv): Received SN_OAMS_PSSCM_NS_PROV_NSEI from PSSCM");
            sndPtr = ((yPDP_sig_OAMS_PSSCM_NS_PROV_NSEI)(*SignalOut))->Param1;
            msgSize = ((yPDP_sig_OAMS_PSSCM_NS_PROV_NSEI)(*SignalOut))->Param2;
            if (sndPtr == NULL)
            {
               LOG_PRINT(MAJOR,"(xOutEnv):Received NULL pointer from Module, Returning without Sending to FRAMEWORK");
               xReleaseSignal(SignalOut);
               return ;
            }
            break;
         }

      case SN_OAMS_PSSCM_NS_UNPROV_SIG_BVC:
         {
            LOG_PRINT(DEBUG,"(xOutEnv): Received SN_OAMS_PSSCM_NS_UNPROV_SIG_BVC from PSSCM");
            sndPtr = ((yPDP_sig_OAMS_PSSCM_NS_UNPROV_SIG_BVC)(*SignalOut))->Param1;
            msgSize = ((yPDP_sig_OAMS_PSSCM_NS_UNPROV_SIG_BVC)(*SignalOut))->Param2;
            if (sndPtr == NULL)
            {
               LOG_PRINT(MAJOR,"(xOutEnv):Received NULL pointer from Module, Returning without Sending to FRAMEWORK");
               xReleaseSignal(SignalOut);
               return ;
            }
            break;
         }

      case SN_OAMS_PSSCM_NS_PROV_LEP:
         {
            LOG_PRINT(DEBUG,"(xOutEnv): Received SN_OAMS_PSSCM_NS_PROV_LEP from PSSCM");
            sndPtr = ((yPDP_sig_OAMS_PSSCM_NS_PROV_LEP)(*SignalOut))->Param1;
            msgSize = ((yPDP_sig_OAMS_PSSCM_NS_PROV_LEP)(*SignalOut))->Param2;
            if (sndPtr == NULL)
            {
               LOG_PRINT(MAJOR,"(xOutEnv):Received NULL pointer from Module, Returning without Sending to FRAMEWORK");
               xReleaseSignal(SignalOut);
               return ;
            }
            break;
         }

      case SN_OAMS_PSSCM_NS_UNPROV_LEP:
         {
            LOG_PRINT(DEBUG,"(xOutEnv): Received SN_OAMS_PSSCM_NS_UNPROV_LEP from PSSCM");
            sndPtr = ((yPDP_sig_OAMS_PSSCM_NS_UNPROV_LEP)(*SignalOut))->Param1;
            msgSize = ((yPDP_sig_OAMS_PSSCM_NS_UNPROV_LEP)(*SignalOut))->Param2;
            if (sndPtr == NULL)
            {
               LOG_PRINT(MAJOR,"(xOutEnv):Received NULL pointer from Module, Returning without Sending to FRAMEWORK");
               xReleaseSignal(SignalOut);
               return ;
            }
            break;
         }


      case SN_OAMS_PSSCM_NS_PROV_REP:
         {
            LOG_PRINT(DEBUG,"(xOutEnv): Received SN_OAMS_PSSCM_NS_PROV_REP  from PSSCM");
            sndPtr = ((yPDP_sig_OAMS_PSSCM_NS_PROV_REP)(*SignalOut))->Param1;
            msgSize = ((yPDP_sig_OAMS_PSSCM_NS_PROV_REP)(*SignalOut))->Param2;
            if (sndPtr == NULL)
            {
               LOG_PRINT(MAJOR,"(xOutEnv):Received NULL pointer from Module, Returning without Sending to FRAMEWORK");
               xReleaseSignal(SignalOut);
               return ;
            }
            break;
         }


      case SN_OAMS_PSSCM_NS_UNPROV_REP:
         {
            LOG_PRINT(DEBUG,"(xOutEnv): Received SN_OAMS_PSSCM_NS_UNPROV_REP from PSSCM");
            sndPtr = ((yPDP_sig_OAMS_PSSCM_NS_UNPROV_REP)(*SignalOut))->Param1;
            msgSize = ((yPDP_sig_OAMS_PSSCM_NS_UNPROV_REP)(*SignalOut))->Param2;
            if (sndPtr == NULL)
            {
               LOG_PRINT(MAJOR,"(xOutEnv):Received NULL pointer from Module, Returning without Sending to FRAMEWORK");
               xReleaseSignal(SignalOut);
               return ;
            }
            break;
         }

      case SN_OAMS_PSSCM_NS_TEST_ENABLE:
         {
            LOG_PRINT(DEBUG,"(xOutEnv): Received from SN_OAMS_PSSCM_NS_TEST_ENABLE PSSCM");
            sndPtr = ((yPDP_sig_OAMS_PSSCM_NS_TEST_ENABLE)(*SignalOut))->Param1;
            msgSize = ((yPDP_sig_OAMS_PSSCM_NS_TEST_ENABLE)(*SignalOut))->Param2;
            if (sndPtr == NULL)
            {
               LOG_PRINT(MAJOR,"(xOutEnv):Received NULL pointer from Module, Returning without Sending to FRAMEWORK");
               xReleaseSignal(SignalOut);
               return ;
            }
            break;
         }

      case SN_OAMS_PSSCM_NS_AUTO_CONFIG:
         {
            LOG_PRINT(DEBUG,"(xOutEnv): Received SN_OAMS_PSSCM_NS_AUTO_CONFIG from PSSCM");
            sndPtr = ((yPDP_sig_OAMS_PSSCM_NS_AUTO_CONFIG)(*SignalOut))->Param1;
            msgSize = ((yPDP_sig_OAMS_PSSCM_NS_AUTO_CONFIG)(*SignalOut))->Param2;
            if (sndPtr == NULL)
            {
               LOG_PRINT(MAJOR,"(xOutEnv):Received NULL pointer from Module, Returning without Sending to FRAMEWORK");
               xReleaseSignal(SignalOut);
               return ;
            }
            break;
         }

      case SN_OAMS_PSSCM_NS_UNPROV_PTP_BVC:
         {
            LOG_PRINT(DEBUG,"(xOutEnv): Received SN_OAMS_PSSCM_NS_UNPROV_PTP_BVC from PSSCM");
            sndPtr = ((yPDP_sig_OAMS_PSSCM_NS_UNPROV_PTP_BVC)(*SignalOut))->Param1;
            msgSize = ((yPDP_sig_OAMS_PSSCM_NS_UNPROV_PTP_BVC)(*SignalOut))->Param2;
            if (sndPtr == NULL)
            {
               LOG_PRINT(MAJOR,"(xOutEnv):Received NULL pointer from Module, Returning without Sending to FRAMEWORK");
               xReleaseSignal(SignalOut);
               return ;
            }
            break;
         }

      case SN_OAMS_PSSCM_NS_PROV_PTP_BVC:
         {
            LOG_PRINT(DEBUG,"(xOutEnv): Received SN_OAMS_PSSCM_NS_PROV_PTP_BVC from PSSCM");
            sndPtr = ((yPDP_sig_OAMS_PSSCM_NS_PROV_PTP_BVC)(*SignalOut))->Param1;
            msgSize = ((yPDP_sig_OAMS_PSSCM_NS_PROV_PTP_BVC)(*SignalOut))->Param2;
            if (sndPtr == NULL)
            {
               LOG_PRINT(MAJOR,"(xOutEnv):Received NULL pointer from Module, Returning without Sending to FRAMEWORK");
               xReleaseSignal(SignalOut);
               return ;
            }
            break;
         }

      case SN_OAMS_PSSCM_PSCH_PROV_PTP_BVC_CNF:
         {
            LOG_PRINT(DEBUG,"(xOutEnv): Received SN_OAMS_PSSCM_PSCH_PROV_PTP_BVC_CNF from PSSCM");
            sndPtr = ((yPDP_sig_OAMS_PSSCM_PSCH_PROV_PTP_BVC_CNF)(*SignalOut))->Param1;
            msgSize = ((yPDP_sig_OAMS_PSSCM_PSCH_PROV_PTP_BVC_CNF)(*SignalOut))->Param2;
            if (sndPtr == NULL)
            {
               LOG_PRINT(MAJOR,"(xOutEnv):Received NULL pointer from Module, Returning without Sending to FRAMEWORK");
               xReleaseSignal(SignalOut);
               return ;
            }
            break;
         }

      case SN_OAMS_PSSCM_PSCH_UNPROV_PTP_BVC_CNF:
         {
            LOG_PRINT(DEBUG,"(xOutEnv): Received SN_OAMS_PSSCM_PSCH_UNPROV_PTP_BVC_CNF from PSSCM");
            sndPtr = ((yPDP_sig_OAMS_PSSCM_PSCH_UNPROV_PTP_BVC_CNF)(*SignalOut))->Param1;
            msgSize = ((yPDP_sig_OAMS_PSSCM_PSCH_UNPROV_PTP_BVC_CNF)(*SignalOut))->Param2;
            if (sndPtr == NULL)
            {
               LOG_PRINT(MAJOR,"(xOutEnv):Received NULL pointer from Module, Returning without Sending to FRAMEWORK");
               xReleaseSignal(SignalOut);
               return ;
            }
            break;
         }

      case SN_OAMS_PSSCM_BSSGP_PROV_SIG_BVC:
         {
            LOG_PRINT(DEBUG,"(xOutEnv): Received SN_OAMS_PSSCM_BSSGP_PROV_SIG_BVC from PSSCM");
            sndPtr = ((yPDP_sig_OAMS_PSSCM_BSSGP_PROV_SIG_BVC)(*SignalOut))->Param1;
            msgSize = ((yPDP_sig_OAMS_PSSCM_BSSGP_PROV_SIG_BVC)(*SignalOut))->Param2;
            if (sndPtr == NULL)
            {
               LOG_PRINT(MAJOR,"(xOutEnv):Received NULL pointer from Module, Returning without Sending to FRAMEWORK");
               xReleaseSignal(SignalOut);
               return ;
            }
            break;
         }


      case SN_OAMS_PSSCM_BSSGP_UNPROV_SIG_BVC:
         {
            LOG_PRINT(DEBUG,"(xOutEnv): Received from SN_OAMS_PSSCM_BSSGP_UNPROV_SIG_BVC PSSCM");
            sndPtr = ((yPDP_sig_OAMS_PSSCM_BSSGP_UNPROV_SIG_BVC)(*SignalOut))->Param1;
            msgSize = ((yPDP_sig_OAMS_PSSCM_BSSGP_UNPROV_SIG_BVC)(*SignalOut))->Param2;
            if (sndPtr == NULL)
            {
               LOG_PRINT(MAJOR,"(xOutEnv):Received NULL pointer from Module, Returning without Sending to FRAMEWORK");
               xReleaseSignal(SignalOut);
               return ;
            }
            break;
         }

      case SN_OAMS_PSSCM_BSSGP_PROV_PTP_BVC:
         {
            LOG_PRINT(DEBUG,"(xOutEnv): Received SN_OAMS_PSSCM_BSSGP_PROV_PTP_BVC from PSSCM");
            sndPtr = ((yPDP_sig_OAMS_PSSCM_BSSGP_PROV_PTP_BVC)(*SignalOut))->Param1;
            msgSize = ((yPDP_sig_OAMS_PSSCM_BSSGP_PROV_PTP_BVC)(*SignalOut))->Param2;
            if (sndPtr == NULL)
            {
               LOG_PRINT(MAJOR,"(xOutEnv):Received NULL pointer from Module, Returning without Sending to FRAMEWORK");
               xReleaseSignal(SignalOut);
               return ;
            }
            break;
         }

      case SN_OAMS_PSSCM_BSSGP_UNPROV_PTP_BVC:
         {
            LOG_PRINT(DEBUG,"(xOutEnv): Received SN_OAMS_PSSCM_BSSGP_UNPROV_PTP_BVC from PSSCM");
            sndPtr = ((yPDP_sig_OAMS_PSSCM_BSSGP_UNPROV_PTP_BVC)(*SignalOut))->Param1;
            msgSize = ((yPDP_sig_OAMS_PSSCM_BSSGP_UNPROV_PTP_BVC)(*SignalOut))->Param2;
            if (sndPtr == NULL)
            {
               LOG_PRINT(MAJOR,"(xOutEnv):Received NULL pointer from Module, Returning without Sending to FRAMEWORK");
               xReleaseSignal(SignalOut);
               return ;
            }
            break;
         }

      case SN_OAMS_NSVCH_NS_PROV_FR_LINK:
         {
            sndPtr = ((yPDP_sig_OAMS_NSVCH_NS_PROV_FR_LINK)(*SignalOut))->Param1;
            msgSize = ((yPDP_sig_OAMS_NSVCH_NS_PROV_FR_LINK)(*SignalOut))->Param2;
            if (sndPtr == NULL)
            {
               LOG_PRINT(MAJOR,"(xOutEnv):Received NULL pointer from Module, Returning without Sending to FRAMEWORK");
               xReleaseSignal(SignalOut);
               return ;
            }
            break;
         }
      case SN_OAMS_NSVCH_NS_UNPROV_FR_LINK:
         {
            sndPtr = ((yPDP_sig_OAMS_NSVCH_NS_UNPROV_FR_LINK)(*SignalOut))->Param1;
            msgSize = ((yPDP_sig_OAMS_NSVCH_NS_UNPROV_FR_LINK)(*SignalOut))->Param2;
            if (sndPtr == NULL)
            {
               LOG_PRINT(MAJOR,"(xOutEnv):Received NULL pointer from Module, Returning without Sending to FRAMEWORK");
               xReleaseSignal(SignalOut);
               return ;
            }
            break;
         }


      case SN_OAMS_NSVCH_NS_PROV_NSVC:
         {
            sndPtr = ((yPDP_sig_OAMS_NSVCH_NS_PROV_NSVC)(*SignalOut))->Param1;
            msgSize = ((yPDP_sig_OAMS_NSVCH_NS_PROV_NSVC)(*SignalOut))->Param2;
            if (sndPtr == NULL)
            {
               LOG_PRINT(MAJOR,"(xOutEnv):Received NULL pointer from Module, Returning without Sending to FRAMEWORK");
               xReleaseSignal(SignalOut);
               return ;
            }
            break;
         }
      case SN_OAMS_NSVCH_NS_UNPROV_NSVC:
         {
            sndPtr = ((yPDP_sig_OAMS_NSVCH_NS_UNPROV_NSVC)(*SignalOut))->Param1;
            msgSize = ((yPDP_sig_OAMS_NSVCH_NS_UNPROV_NSVC)(*SignalOut))->Param2;
            if (sndPtr == NULL)
            {
               LOG_PRINT(MAJOR,"(xOutEnv):Received NULL pointer from Module, Returning without Sending to FRAMEWORK");
               xReleaseSignal(SignalOut);
               return ;
            }
            break;
         }
      case SN_OAMS_NSVCH_NS_ADD_NSVC_TO_NSEI_GRP:
         {
            sndPtr = ((yPDP_sig_OAMS_NSVCH_NS_ADD_NSVC_TO_NSEI_GRP)(*SignalOut))->Param1;
            msgSize = ((yPDP_sig_OAMS_NSVCH_NS_ADD_NSVC_TO_NSEI_GRP)(*SignalOut))->Param2;
            if (sndPtr == NULL)
            {
               LOG_PRINT(MAJOR,"(xOutEnv):Received NULL pointer from Module, Returning without Sending to FRAMEWORK");
               xReleaseSignal(SignalOut);
               return ;
            }
            break;
         }
      case SN_OAMS_NSVCH_NS_REM_NSVC_NSEI_GRP:
         {
            sndPtr = ((yPDP_sig_OAMS_NSVCH_NS_REM_NSVC_NSEI_GRP)(*SignalOut))->Param1;
            msgSize = ((yPDP_sig_OAMS_NSVCH_NS_REM_NSVC_NSEI_GRP)(*SignalOut))->Param2;
            if (sndPtr == NULL)
            {
               LOG_PRINT(MAJOR,"(xOutEnv):Received NULL pointer from Module, Returning without Sending to FRAMEWORK");
               xReleaseSignal(SignalOut);
               return ;
            }
            break;
         }
      case SN_OAMS_NSVCH_NS_NSVC_RESET:
         {
            sndPtr = ((yPDP_sig_OAMS_NSVCH_NS_NSVC_RESET)(*SignalOut))->Param1;
            msgSize = ((yPDP_sig_OAMS_NSVCH_NS_NSVC_RESET)(*SignalOut))->Param2;
            if (sndPtr == NULL)
            {
               LOG_PRINT(MAJOR,"(xOutEnv):Received NULL pointer from Module, Returning without Sending to FRAMEWORK");
               xReleaseSignal(SignalOut);
               return ;
            }
            break;
         }
      case SN_OAMS_NSVCH_NS_NSVC_BLOCK:
         {
            sndPtr = ((yPDP_sig_OAMS_NSVCH_NS_NSVC_BLOCK)(*SignalOut))->Param1;
            msgSize = ((yPDP_sig_OAMS_NSVCH_NS_NSVC_BLOCK)(*SignalOut))->Param2;
            if (sndPtr == NULL)
            {
               LOG_PRINT(MAJOR,"(xOutEnv):Received NULL pointer from Module, Returning without Sending to FRAMEWORK");
               xReleaseSignal(SignalOut);
               return ;
            }
            break;
         }
      case SN_OAMS_NSVCH_NS_NSVC_UNBLOCK:
         {
            sndPtr = ((yPDP_sig_OAMS_NSVCH_NS_NSVC_UNBLOCK)(*SignalOut))->Param1;
            msgSize = ((yPDP_sig_OAMS_NSVCH_NS_NSVC_UNBLOCK)(*SignalOut))->Param2;
            if (sndPtr == NULL)
            {
               LOG_PRINT(MAJOR,"(xOutEnv):Received NULL pointer from Module, Returning without Sending to FRAMEWORK");
               xReleaseSignal(SignalOut);
               return ;
            }
            break;
         }
      case SN_OAMS_NSVCH_NS_NSVC_DOWN:
         {
            sndPtr = ((yPDP_sig_OAMS_NSVCH_NS_NSVC_DOWN)(*SignalOut))->Param1;
            msgSize = ((yPDP_sig_OAMS_NSVCH_NS_NSVC_DOWN)(*SignalOut))->Param2;
            if (sndPtr == NULL)
            {
               LOG_PRINT(MAJOR,"(xOutEnv):Received NULL pointer from Module, Returning without Sending to FRAMEWORK");
               xReleaseSignal(SignalOut);
               return ;
            }
            break;
         }
      case SN_OAMS_NSVCH_NS_N_CONN_IND:
         {
            sndPtr = ((yPDP_sig_OAMS_NSVCH_NS_N_CONN_IND)(*SignalOut))->Param1;
            msgSize = ((yPDP_sig_OAMS_NSVCH_NS_N_CONN_IND)(*SignalOut))->Param2;
            if (sndPtr == NULL)
            {
               LOG_PRINT(MAJOR,"(xOutEnv):Received NULL pointer from Module, Returning without Sending to FRAMEWORK");
               xReleaseSignal(SignalOut);
               return ;
            }
            break;
         }
      case SN_OAMS_NSVCH_NS_N_DISC_IND:
         {
            sndPtr = ((yPDP_sig_OAMS_NSVCH_NS_N_DISC_IND)(*SignalOut))->Param1;
            msgSize = ((yPDP_sig_OAMS_NSVCH_NS_N_DISC_IND)(*SignalOut))->Param2;
            if (sndPtr == NULL)
            {
               LOG_PRINT(MAJOR,"(xOutEnv):Received NULL pointer from Module, Returning without Sending to FRAMEWORK");
               xReleaseSignal(SignalOut);
               return ;
            }
            break;
         }
      case SN_OAMS_NSVCH_FR_N_START_REQ:
         {
            sndPtr = ((yPDP_sig_OAMS_NSVCH_FR_N_START_REQ)(*SignalOut))->Param1;
            msgSize = ((yPDP_sig_OAMS_NSVCH_FR_N_START_REQ)(*SignalOut))->Param2;
            if (sndPtr == NULL)
            {
               LOG_PRINT(MAJOR,"(xOutEnv):Received NULL pointer from Module, Returning without Sending to FRAMEWORK");
               xReleaseSignal(SignalOut);
               return ;
            }
            break;
         }

      case SN_OAMS_NSVCH_FR_N_STOP_REQ:
         {
            sndPtr = ((yPDP_sig_OAMS_NSVCH_FR_N_STOP_REQ)(*SignalOut))->Param1;
            msgSize = ((yPDP_sig_OAMS_NSVCH_FR_N_STOP_REQ)(*SignalOut))->Param2;
            if (sndPtr == NULL)
            {
               LOG_PRINT(MAJOR,"(xOutEnv):Received NULL pointer from Module, Returning without Sending to FRAMEWORK");
               xReleaseSignal(SignalOut);
               return ;
            }
            break;
         }
      case SN_OAMS_NSVCH_CFG_UNLOCK_RESP:
         {
            sndPtr = ((yPDP_sig_OAMS_NSVCH_CFG_UNLOCK_RESP)(*SignalOut))->Param1;
            msgSize = ((yPDP_sig_OAMS_NSVCH_CFG_UNLOCK_RESP)(*SignalOut))->Param2;
            if (sndPtr == NULL)
            {
               LOG_PRINT(MAJOR,"(xOutEnv):Received NULL pointer from Module, Returning without Sending to FRAMEWORK");
               xReleaseSignal(SignalOut);
               return ;
            }
            break;
         }
      case SN_OAMS_NSVCH_CFG_LOCK_RESP:
         {
            sndPtr = ((yPDP_sig_OAMS_NSVCH_CFG_LOCK_RESP)(*SignalOut))->Param1;
            msgSize = ((yPDP_sig_OAMS_NSVCH_CFG_LOCK_RESP)(*SignalOut))->Param2;
            if (sndPtr == NULL)
            {
               LOG_PRINT(MAJOR,"(xOutEnv):Received NULL pointer from Module, Returning without Sending to FRAMEWORK");
               xReleaseSignal(SignalOut);
               return ;
            }
            break;
         }
      case SN_OAMS_NSVCH_CFG_ALARM_IND:
         {
            sndPtr = ((yPDP_sig_OAMS_NSVCH_CFG_ALARM_IND)(*SignalOut))->Param1;
            msgSize = ((yPDP_sig_OAMS_NSVCH_CFG_ALARM_IND)(*SignalOut))->Param2;
            if (sndPtr == NULL)
            {
               LOG_PRINT(MAJOR,"(xOutEnv):Received NULL pointer from Module, Returning without Sending to FRAMEWORK");
               xReleaseSignal(SignalOut);
               return ;
            }
            break;
         }

      case SN_NSVCH_INT_SELFCARD_STATE_CHANGE_RESP :
         LOG_PRINT(DEBUG, "(xOutEnv) : Received signal SN_NSVCH_INT_SELFCARD_STATE_CHANGE_RESP");
         gSignalSent--;
         LOG_PRINT(INFO, "gSignalSent: %d", gSignalSent);
         if ( gSignalSent == 0 )
         {
            LOG_PRINT(INFO," All instances goes to INIT State while going ACTIVE to INSERVICE/RECOVERY state. ");
            updateCardStatus();
                 LOG_PRINT(INFO,"(BPM)Releasing semaphore.. ");
                 SEM_POST(&gSemHandler);
         }
         xReleaseSignal(SignalOut);
         return;

      case SN_PSSCM_INT_SELFCARD_STATE_CHANGE_RESP :
         LOG_PRINT(DEBUG, "(xOutEnv) : Received signal SN_PSSCM_INT_SELFCARD_STATE_CHANGE_RESP");
         gSignalSent--;
         LOG_PRINT(INFO, "gSignalSent: %d", gSignalSent);
         if ( gSignalSent == 0 )
         {
            LOG_PRINT(INFO," All instances goes to INIT State while going ACTIVE to INSERVICE/RECOVERY state. ");
            updateCardStatus();
                 LOG_PRINT(INFO,"(BPM)Releasing semaphore.. ");
                 SEM_POST(&gSemHandler);
         }
         xReleaseSignal(SignalOut);
         return;

      case SN_OAMS_NSVCH_ADD_TAU_INST_IN_INSTMAP :
         LOG_PRINT(INFO,"(xOutEnv):Received  Signal OAMS_NSVCH_ADD_TAU_INST_IN_INSTMAP");
         lclPidPtr = (I_U32)((*SignalOut)->Sender.LocalPId);
         if ((retVal = AddTauInst(lclPidPtr,ENT_OAMS_PSSCM, NSVCH_CLASS)) < 0)
         {
            LOG_PRINT(CRITICAL, "(xOutEnv) : AddTauInstId() Failed lclPidPtr = 0x%x [Act Cls Id = %d]",lclPidPtr, NSVCH_CLASS);
         }
         else
         {
            LOG_PRINT(INFO, "(xOutEnv): AddTauInstId() Success lclPidPtr = 0x%x [Act Cls Id = %d]",lclPidPtr, NSVCH_CLASS);
         recvdMsgs++;
                LOG_PRINT(INFO,"(ENV:xOutEnv)Here recvDMsgs are :: %d and gInstCount is :: %d ", recvdMsgs, gInstCount);

         if( recvdMsgs == gInstCount && gInstancesCreated == I_FALSE)
                {
                      updateCardStatus();
                     gInstancesCreated = I_TRUE;
                      LOG_PRINT(INFO,"(ENV:xOutEnv)Releasing semaphore.. ");
                      SEM_POST(&gSemHandler);
                      LOG_PRINT(INFO,"(ENV:xOutEnv)Moving to INSERVICE.. ");
                      recvdMsgs = 0;
               }

         }
         xReleaseSignal(SignalOut);
         return;

      case SN_OAMS_NSVCH_FREE_INST :
         LOG_PRINT(INFO,"(xOutEnv):Received  Signal NSVCH_FREE_INST");
         lclPidPtr = (I_U32)((*SignalOut)->Sender.LocalPId);
         if ((retVal = FreInstId(lclPidPtr,ENT_OAMS_PSSCM, NSVCH_CLASS)) < 0)
         {
            LOG_PRINT(CRITICAL, "(xOutEnv): FreInstId() Failed lclPidPtr = 0x%x [Act Cls Id = %d]",lclPidPtr, NSVCH_CLASS);
         }
         else
         {
            LOG_PRINT(INFO, "(xOutEnv): FreTauInstId() Success lclPidPtr = 0x%x [Act Cls Id = %d]",lclPidPtr,NSVCH_CLASS);
         }
         xReleaseSignal(SignalOut);
         return;

      case SN_SEND_PSSCM_PID_PTR :
         gLclPidPsscmActiveClass = (I_U32)((*SignalOut)->Sender.LocalPId);
         LOG_PRINT(DEBUG, "(xOutEnv) : Active class LCLPID: 0x%0x", \
               gLclPidPsscmActiveClass);
         LOG_PRINT(DEBUG," (xOutEnv):LocalPid for Psscm active class is %d",gLclPidPsscmActiveClass);
         xReleaseSignal(SignalOut);
         return;

      default:
         LOG_PRINT(MAJOR,"(xOutEnv): Invalid Signal Rcvd From Model(Signal number=%d)",(*SignalOut)->NameNode->SignalNumber);
         sndPtr = ((yPDP_sig_OAMS_PSSCM_NS_PROV_SIG_BVC)(*SignalOut))->Param1;
         if (sndPtr !=NULL)
         {
            DalocMsgBuf((I_Void *)sndPtr);
         }
         xReleaseSignal(SignalOut);
         return;

   }
   LOG_PRINT(INFO,"(xOutEnv): (Env):OUT OF SWITCH XOUT::ENV \n ");
   if (SendMsg(sndPtr,MSG_ORD_PRIO,msgSize) == SND_FAIL)
   {
      LOG_PRINT(CRITICAL,"(xOutEnv):MESSAGE SENDING FAILED \n");
   }
   else
   {
      LOG_PRINT(INFO,"(xOutEnv):Successfully sent message out \n");
   }
   xReleaseSignal(SignalOut);


}



/*---+---------------------------------------------------------------
  Macros for xInEnv
  -------------------------------------------------------------------*/
#ifndef IN_LOCAL_VARIABLES
#define IN_LOCAL_VARIABLES \
   xSignalNode SignalIn;
#endif

#ifndef IN_SIGNAL1
#define IN_SIGNAL1(SIGNAL_NAME, SIGNAL_NAME_STRING) \
   SignalIn = xGetSignal(SIGNAL_NAME, xNotDefPId, xEnv);
#endif

#ifndef IN_SIGNAL2
#define IN_SIGNAL2(SIGNAL_NAME, SIGNAL_NAME_STRING) \
   SDL_Output(SignalIn xSigPrioPar(xDefaultPrioSignal), (xIdNode *)0);
#endif

#ifndef IF_IN_SIGNAL
#define IF_IN_SIGNAL(SIGNAL_NAME, SIGNAL_NAME_STRING) \
   if (TEST_IF_IN_SIGNAL(SIGNAL_NAME)) {
#define END_IF_IN_SIGNAL(SIGNAL_NAME, SIGNAL_NAME_STRING) \
   }
#endif

#ifndef TEST_IF_IN_SIGNAL
#define TEST_IF_IN_SIGNAL(SIGNAL_NAME)  0
#endif

#ifndef XENV_DEC
#define XENV_DEC(stmt) stmt
#endif

#ifndef XENV_IN_START
#define XENV_IN_START
#endif

#ifndef XENV_IN_END
#define XENV_IN_END
#endif


/*---+---------------------------------------------------------------
  xInEnv  extern
  -------------------------------------------------------------------*/
#ifndef XTENV
extern void xInEnv ( SDL_Time Time_for_next_event )
#else
extern SDL_Duration xInEnv ( SDL_Time Time_for_next_event )
#endif
{
   xSignalNode S;
   I_PVoid rcvPtr = NULL;
   I_U32   msgSize;
   SDL_Pid rcvr;
   I_U32          refId1;
   I_U32          refId2;
   I_S8            instCountResult = ZERO;
   I_U32           lclPidPtr;
   I_S32          instId;
     I_U16          msgType;
   
   static int initInstance = 0;
   struct sAisParam *param;

   lclPidPtr = INVALID_LCL_PID_PTR;


   if ((rcvPtr = (I_Void *)RecvMsg(selfEntIdG, &msgSize)) != NULL)
   {
      rcvr.GlobalNodeNr = (I_S32)selfEntIdG;
           msgType = ((SysHdr *)rcvPtr)->msgType;
           if ( gCurrentCardState == CARDSTATE_ACTIVE)
           {
      switch(msgType)
      {
         case OAMS_CFG_PSSCM_UNLOCK_REQ :
            LOG_PRINT(INFO,"xInEnv : OAMS_CFG_PSSCM_UNLOCK_REQ received ");
                                rcvr.LocalPId = (xLocalPIdNode)gLclPidPsscmActiveClass;
            S = xGetSignal( sig_OAMS_CFG_PSSCM_UNLOCK_REQ, rcvr, xEnv);
            ((yPDP_sig_OAMS_CFG_PSSCM_UNLOCK_REQ)S)->Param1 = rcvPtr;
            break;

         case OAMS_CFG_PSSCM_LOCK_REQ :
            LOG_PRINT(INFO,"xInEnv : OAMS_CFG_PSSCM_LOCK_REQ received ");
                                rcvr.LocalPId = (xLocalPIdNode)gLclPidPsscmActiveClass;
            S = xGetSignal( sig_OAMS_CFG_PSSCM_LOCK_REQ, rcvr, xEnv);
            ((yPDP_sig_OAMS_CFG_PSSCM_LOCK_REQ)S)->Param1 = rcvPtr;
            break;


         case OAMS_PSCH_PSSCM_PROV_PTP_BVC :
            LOG_PRINT(INFO,"xInEnv : OAMS_PSCH_PSSCM_PROV_PTP_BVC received ");
                                rcvr.LocalPId = (xLocalPIdNode)gLclPidPsscmActiveClass;
            S = xGetSignal( sig_OAMS_PSCH_PSSCM_PROV_PTP_BVC, rcvr, xEnv);
            ((yPDP_sig_OAMS_PSCH_PSSCM_PROV_PTP_BVC)S)->Param1 = rcvPtr;
            break;

         case OAMS_PSCH_PSSCM_UNPROV_PTP_BVC :
            LOG_PRINT(INFO,"xInEnv : OAMS_PSCH_PSSCM_UNPROV_PTP_BVC received ");
                                rcvr.LocalPId = (xLocalPIdNode)gLclPidPsscmActiveClass;
            S = xGetSignal( sig_OAMS_PSCH_PSSCM_UNPROV_PTP_BVC, rcvr, xEnv);
            ((yPDP_sig_OAMS_PSCH_PSSCM_UNPROV_PTP_BVC)S)->Param1 = rcvPtr;
            break;

         case PSSKS_BSSGP_PSSCM_PROV_SIG_BVC_CNF :
            LOG_PRINT(INFO,"xInEnv : PSSKS_BSSGP_PSSCM_PROV_SIG_BVC_CNF received ");
                                rcvr.LocalPId = (xLocalPIdNode)gLclPidPsscmActiveClass;
            S = xGetSignal( sig_PSSKS_BSSGP_PSSCM_PROV_SIG_BVC_CNF, rcvr, xEnv);
            ((yPDP_sig_PSSKS_BSSGP_PSSCM_PROV_SIG_BVC_CNF)S)->Param1 = rcvPtr;
            break;
         case PSSKS_BSSGP_PSSCM_UNPROV_SIG_BVC_CNF :
            LOG_PRINT(INFO,"xInEnv : PSSKS_BSSGP_PSSCM_UNPROV_SIG_BVC_CNF received ");
                                rcvr.LocalPId = (xLocalPIdNode)gLclPidPsscmActiveClass;
            S = xGetSignal( sig_PSSKS_BSSGP_PSSCM_UNPROV_SIG_BVC_CNF, rcvr, xEnv);
            ((yPDP_sig_PSSKS_BSSGP_PSSCM_UNPROV_SIG_BVC_CNF)S)->Param1 = rcvPtr;
            break;
         case PSSKS_BSSGP_PSSCM_PROV_PTP_BVC_CNF :
            LOG_PRINT(INFO,"xInEnv : PSSKS_BSSGP_PSSCM_PROV_PTP_BVC_CNF received ");
                                rcvr.LocalPId = (xLocalPIdNode)gLclPidPsscmActiveClass;
            S = xGetSignal( sig_PSSKS_BSSGP_PSSCM_PROV_PTP_BVC_CNF, rcvr, xEnv);
            ((yPDP_sig_PSSKS_BSSGP_PSSCM_PROV_PTP_BVC_CNF)S)->Param1 = rcvPtr;
            break;
         case PSSKS_BSSGP_PSSCM_UNPROV_PTP_BVC_CNF :
            LOG_PRINT(INFO,"xInEnv : PSSKS_BSSGP_PSSCM_UNPROV_PTP_BVC_CNF received ");
                                rcvr.LocalPId = (xLocalPIdNode)gLclPidPsscmActiveClass;
            S = xGetSignal( sig_PSSKS_BSSGP_PSSCM_UNPROV_PTP_BVC_CNF, rcvr, xEnv);
            ((yPDP_sig_PSSKS_BSSGP_PSSCM_UNPROV_PTP_BVC_CNF)S)->Param1 = rcvPtr;
            break;
         case PSSKS_BSSGP_PSSCM_ALARM_IND :
            LOG_PRINT(INFO,"xInEnv : PSSKS_BSSGP_PSSCM_ALARM_IND received ");
                                rcvr.LocalPId = (xLocalPIdNode)gLclPidPsscmActiveClass;
            S = xGetSignal( sig_PSSKS_BSSGP_PSSCM_ALARM_IND, rcvr, xEnv);
            ((yPDP_sig_PSSKS_BSSGP_PSSCM_ALARM_IND)S)->Param1 = rcvPtr;
            break;

         case PSSKS_NS_PSSCM_PROV_NSEI_CNF :
            LOG_PRINT(INFO,"xInEnv : PSSKS_NS_PSSCM_PROV_NSEI_CNF received ");
                                rcvr.LocalPId = (xLocalPIdNode)gLclPidPsscmActiveClass;
            S = xGetSignal( sig_PSSKS_NS_PSSCM_PROV_NSEI_CNF, rcvr, xEnv);
            ((yPDP_sig_PSSKS_NS_PSSCM_PROV_NSEI_CNF)S)->Param1 = rcvPtr;
            break;
         case PSSKS_NS_PSSCM_UNPROV_NSEI_CNF :
            LOG_PRINT(INFO,"xInEnv : PSSKS_NS_PSSCM_UNPROV_NSEI_CNF received ");
                                rcvr.LocalPId = (xLocalPIdNode)gLclPidPsscmActiveClass;
            S = xGetSignal( sig_PSSKS_NS_PSSCM_UNPROV_NSEI_CNF, rcvr, xEnv);
            ((yPDP_sig_PSSKS_NS_PSSCM_UNPROV_NSEI_CNF)S)->Param1 = rcvPtr;
            break;

         case PSSKS_NS_PSSCM_PROV_SIG_BVC_CNF :
            LOG_PRINT(INFO,"xInEnv : PSSKS_NS_PSSCM_PROV_SIG_BVC_CNF received ");
                                rcvr.LocalPId = (xLocalPIdNode)gLclPidPsscmActiveClass;
            S = xGetSignal( sig_PSSKS_NS_PSSCM_PROV_SIG_BVC_CNF, rcvr, xEnv);
            ((yPDP_sig_PSSKS_NS_PSSCM_PROV_SIG_BVC_CNF)S)->Param1 = rcvPtr;
            break;
         case PSSKS_NS_PSSCM_UNPROV_SIG_BVC_CNF :
            LOG_PRINT(INFO,"xInEnv : PSSKS_NS_PSSCM_UNPROV_SIG_BVC_CNF received ");
                                rcvr.LocalPId = (xLocalPIdNode)gLclPidPsscmActiveClass;
            S = xGetSignal( sig_PSSKS_NS_PSSCM_UNPROV_SIG_BVC_CNF, rcvr, xEnv);
            ((yPDP_sig_PSSKS_NS_PSSCM_UNPROV_SIG_BVC_CNF)S)->Param1 = rcvPtr;
            break;

         case PSSKS_NS_PSSCM_PROV_LEP_CNF :
            LOG_PRINT(INFO,"xInEnv : PSSKS_NS_PSSCM_PROV_LEP_CNF received ");
                                rcvr.LocalPId = (xLocalPIdNode)gLclPidPsscmActiveClass;
            S = xGetSignal( sig_PSSKS_NS_PSSCM_PROV_LEP_CNF, rcvr, xEnv);
            ((yPDP_sig_PSSKS_NS_PSSCM_PROV_LEP_CNF)S)->Param1 = rcvPtr;
            break;

         case PSSKS_NS_PSSCM_UNPROV_LEP_CNF :
            LOG_PRINT(INFO,"xInEnv : PSSKS_NS_PSSCM_UNPROV_LEP_CNF received ");
                                rcvr.LocalPId = (xLocalPIdNode)gLclPidPsscmActiveClass;
            S = xGetSignal( sig_PSSKS_NS_PSSCM_UNPROV_LEP_CNF, rcvr, xEnv);
            ((yPDP_sig_PSSKS_NS_PSSCM_UNPROV_LEP_CNF)S)->Param1 = rcvPtr;
            break;
         case PSSKS_NS_PSSCM_PROV_REP_CNF :
            LOG_PRINT(INFO,"xInEnv : PSSKS_NS_PSSCM_PROV_REP_CNF received ");
                                rcvr.LocalPId = (xLocalPIdNode)gLclPidPsscmActiveClass;
            S = xGetSignal( sig_PSSKS_NS_PSSCM_PROV_REP_CNF, rcvr, xEnv);
            ((yPDP_sig_PSSKS_NS_PSSCM_PROV_REP_CNF)S)->Param1 = rcvPtr;
            break;
         case PSSKS_NS_PSSCM_UNPROV_REP_CNF :
            LOG_PRINT(INFO,"xInEnv : PSSKS_NS_PSSCM_UNPROV_REP_CNF received ");
                                rcvr.LocalPId = (xLocalPIdNode)gLclPidPsscmActiveClass;
            S = xGetSignal( sig_PSSKS_NS_PSSCM_UNPROV_REP_CNF, rcvr, xEnv);
            ((yPDP_sig_PSSKS_NS_PSSCM_UNPROV_REP_CNF)S)->Param1 = rcvPtr;
            break;
         case PSSKS_NS_PSSCM_AUTO_CONFIG_CNF :
            LOG_PRINT(INFO,"xInEnv : PSSKS_NS_PSSCM_AUTO_CONFIG_CNF received ");
                                rcvr.LocalPId = (xLocalPIdNode)gLclPidPsscmActiveClass;
            S = xGetSignal( sig_PSSKS_NS_PSSCM_AUTO_CONFIG_CNF, rcvr, xEnv);
            ((yPDP_sig_PSSKS_NS_PSSCM_AUTO_CONFIG_CNF)S)->Param1 = rcvPtr;
            break;
         case PSSKS_NS_PSSCM_TEST_ENABLE_CNF :
            LOG_PRINT(INFO,"xInEnv : PSSKS_NS_PSSCM_TEST_ENABLE_CNF received ");
                                rcvr.LocalPId = (xLocalPIdNode)gLclPidPsscmActiveClass;
            S = xGetSignal( sig_PSSKS_NS_PSSCM_TEST_ENABLE_CNF, rcvr, xEnv);
            ((yPDP_sig_PSSKS_NS_PSSCM_TEST_ENABLE_CNF)S)->Param1 = rcvPtr;
            break;
         case PSSKS_NS_PSSCM_PROV_PTP_BVC_CNF :
            LOG_PRINT(INFO,"xInEnv : PSSKS_NS_PSSCM_PROV_PTP_BVC_CNF received ");
                                rcvr.LocalPId = (xLocalPIdNode)gLclPidPsscmActiveClass;
            S = xGetSignal( sig_PSSKS_NS_PSSCM_PROV_PTP_BVC_CNF, rcvr, xEnv);
            ((yPDP_sig_PSSKS_NS_PSSCM_PROV_PTP_BVC_CNF)S)->Param1 = rcvPtr;
            break;
         case PSSKS_NS_PSSCM_UNPROV_PTP_BVC_CNF :
            LOG_PRINT(INFO,"xInEnv : PSSKS_NS_PSSCM_UNPROV_PTP_BVC_CNF received ");
                                rcvr.LocalPId = (xLocalPIdNode)gLclPidPsscmActiveClass;
            S = xGetSignal( sig_PSSKS_NS_PSSCM_UNPROV_PTP_BVC_CNF, rcvr, xEnv);
            ((yPDP_sig_PSSKS_NS_PSSCM_UNPROV_PTP_BVC_CNF)S)->Param1 = rcvPtr;
            break;
         case PSSKS_NS_PSSCM_ALARM_IND :
            LOG_PRINT(INFO,"xInEnv : PSSKS_NS_PSSCM_ALARM_IND received ");
                                rcvr.LocalPId = (xLocalPIdNode)gLclPidPsscmActiveClass;
            S = xGetSignal( sig_PSSKS_NS_PSSCM_ALARM_IND, rcvr, xEnv);
            ((yPDP_sig_PSSKS_NS_PSSCM_ALARM_IND)S)->Param1 = rcvPtr;
            break;

         case PSSKS_NS_NSVCH_PROV_FR_LINK_CNF :
            GetNsvchRefId(rcvPtr, &refId1, &refId2);
            LOG_PRINT(INFO,"xInEnv : PSSKS_NS_NSVCH_PROV_FR_LINK_CNF received for frChannel - [%d]",refId2);
            if (SearchAlocatedInst(&lclPidPtr,(I_S32*)&instId,ENT_OAMS_PSSCM,NSVCH_CLASS,refId1,refId2,0,0,0) != INST_SUCCESS)
            {
               LOG_PRINT(MAJOR,"(Env):No NSVCH Inst found for frChannel - [%d]\n",refId2);
               DalocMsgBuf((I_Void *)rcvPtr);
               return;
            }
            if (lclPidPtr == 0)
            {
               LOG_PRINT(CRITICAL,"(Env):Invalid Instance Found...\n");
               DalocMsgBuf((I_Void *)rcvPtr);
               return ;
            }
            rcvr.LocalPId = (xLocalPIdNode)lclPidPtr;
            S = xGetSignal( sig_PSSKS_NS_NSVCH_PROV_FR_LINK_CNF, rcvr, xEnv);
            ((yPDP_sig_PSSKS_NS_NSVCH_PROV_FR_LINK_CNF)S)->Param1 = rcvPtr;
            break;

         case PSSKS_NS_NSVCH_UNPROV_FR_LINK_CNF :
            GetNsvchRefId(rcvPtr, &refId1, &refId2);
            LOG_PRINT(INFO,"xInEnv :PSSKS_NS_NSVCH_UNPROV_FR_LINK_CNF received for frChannel - [%d]",refId2);
            if (SearchAlocatedInst(&lclPidPtr,(I_S32*)&instId,ENT_OAMS_PSSCM,NSVCH_CLASS,refId1,refId2,0,0,0) != INST_SUCCESS)
            {
               LOG_PRINT(MAJOR,"(Env):No NSVCH Inst found for frChannel - [%d]\n",refId2);
               DalocMsgBuf((I_Void *)rcvPtr);
               return;
            }
            if (lclPidPtr == 0)
            {
               LOG_PRINT(CRITICAL,"(Env):Invalid Instance Found...\n");
               DalocMsgBuf((I_Void *)rcvPtr);
               return ;
            }
            rcvr.LocalPId = (xLocalPIdNode)lclPidPtr;

            S = xGetSignal( sig_PSSKS_NS_NSVCH_UNPROV_FR_LINK_CNF, rcvr, xEnv);
            ((yPDP_sig_PSSKS_NS_NSVCH_UNPROV_FR_LINK_CNF)S)->Param1 = rcvPtr;
            break;

         case PSSKS_NS_NSVCH_PROV_NSVC_CNF :
            GetNsvchRefId(rcvPtr, &refId1, &refId2);
            LOG_PRINT(INFO,"xInEnv :PSSKS_NS_NSVCH_PROV_NSVC_CNF received for nsvci - [%d]",refId1);
            if (SearchAlocatedInst(&lclPidPtr,(I_S32*)&instId,ENT_OAMS_PSSCM,NSVCH_CLASS,refId1,refId2,0,0,0) != INST_SUCCESS)
            {
               LOG_PRINT(MAJOR,"(Env):No NSVCH Inst found for nsvci - [%d]\n",refId1);
               DalocMsgBuf((I_Void *)rcvPtr);
               return;
            }
            if (lclPidPtr == 0)
            {
               LOG_PRINT(CRITICAL,"(Env):Invalid Instance Found...\n");
               DalocMsgBuf((I_Void *)rcvPtr);
               return ;
            }
            rcvr.LocalPId = (xLocalPIdNode)lclPidPtr;
            S = xGetSignal( sig_PSSKS_NS_NSVCH_PROV_NSVC_CNF, rcvr, xEnv);
            ((yPDP_sig_PSSKS_NS_NSVCH_PROV_NSVC_CNF)S)->Param1 = rcvPtr;
            break;

         case PSSKS_NS_NSVCH_UNPROV_NSVC_CNF :
            GetNsvchRefId(rcvPtr, &refId1, &refId2);
            LOG_PRINT(INFO,"xInEnv :PSSKS_NS_NSVCH_UNPROV_NSVC_CNF received for nsvci - [%d]",refId1);
            if (SearchAlocatedInst(&lclPidPtr,(I_S32*)&instId,ENT_OAMS_PSSCM,NSVCH_CLASS,refId1,refId2,0,0,0) != INST_SUCCESS)
            {
               LOG_PRINT(MAJOR,"(Env):No NSVCH Inst found for nsvci - [%d]\n",refId1);
               DalocMsgBuf((I_Void *)rcvPtr);
               return;
            }
            if (lclPidPtr == 0)
            {
               LOG_PRINT(CRITICAL,"(Env):Invalid Instance Found...\n");
               DalocMsgBuf((I_Void *)rcvPtr);
               return ;
            }
            rcvr.LocalPId = (xLocalPIdNode)lclPidPtr;
            S = xGetSignal( sig_PSSKS_NS_NSVCH_UNPROV_NSVC_CNF, rcvr, xEnv);
            ((yPDP_sig_PSSKS_NS_NSVCH_UNPROV_NSVC_CNF)S)->Param1 = rcvPtr;
            break;

         case PSSKS_NS_NSVCH_ADD_NSVC_TO_NSEI_GRP_CNF :
            GetNsvchRefId(rcvPtr, &refId1, &refId2);
            LOG_PRINT(INFO,"xInEnv :PSSKS_NS_NSVCH_ADD_NSVC_TO_NSEI_GRP_CNF received for nsvci - [%d]",refId1);
            if (SearchAlocatedInst(&lclPidPtr,(I_S32*)&instId,ENT_OAMS_PSSCM,NSVCH_CLASS,refId1,refId2,0,0,0) != INST_SUCCESS)
            {
               LOG_PRINT(MAJOR,"(Env):No NSVCH Inst found for nsvci - [%d]\n",refId1);
               DalocMsgBuf((I_Void *)rcvPtr);
               return;
            }
            if (lclPidPtr == 0)
            {
               LOG_PRINT(CRITICAL,"(Env):Invalid Instance Found...\n");
               DalocMsgBuf((I_Void *)rcvPtr);
               return ;
            }
            rcvr.LocalPId = (xLocalPIdNode)lclPidPtr;
            S = xGetSignal( sig_PSSKS_NS_NSVCH_ADD_NSVC_TO_NSEI_GRP_CNF, rcvr, xEnv);
            ((yPDP_sig_PSSKS_NS_NSVCH_ADD_NSVC_TO_NSEI_GRP_CNF)S)->Param1 = rcvPtr;
            break;

         case PSSKS_NS_NSVCH_REM_NSVC_NSEI_GRP_CNF :
            GetNsvchRefId(rcvPtr, &refId1, &refId2);
            LOG_PRINT(INFO,"xInEnv :PSSKS_NS_NSVCH_REM_NSVC_NSEI_GRP_CNF received for nsvci - [%d]",refId1);
            if (SearchAlocatedInst(&lclPidPtr,(I_S32*)&instId,ENT_OAMS_PSSCM,NSVCH_CLASS,refId1,refId2,0,0,0) != INST_SUCCESS)
            {
               LOG_PRINT(MAJOR,"(Env):No NSVCH Inst found for nsvci - [%d]\n",refId1);
               DalocMsgBuf((I_Void *)rcvPtr);
               return;
            }
            if (lclPidPtr == 0)
            {
               LOG_PRINT(CRITICAL,"(Env):Invalid Instance Found...\n");
               DalocMsgBuf((I_Void *)rcvPtr);
               return ;
            }

            rcvr.LocalPId = (xLocalPIdNode)lclPidPtr;
            S = xGetSignal( sig_PSSKS_NS_NSVCH_REM_NSVC_NSEI_GRP_CNF, rcvr, xEnv);
            ((yPDP_sig_PSSKS_NS_NSVCH_REM_NSVC_NSEI_GRP_CNF)S)->Param1 = rcvPtr;
            break;

         case PSSKS_NS_NSVCH_NSVC_BLOCK_IND :
            GetNsvchRefId(rcvPtr, &refId1, &refId2);
            LOG_PRINT(INFO,"xInEnv :PSSKS_NS_NSVCH_NSVC_BLOCK_IND received for nsvci - [%d]",refId1);
            if (SearchAlocatedInst(&lclPidPtr,(I_S32*)&instId,ENT_OAMS_PSSCM,NSVCH_CLASS,refId1,refId2,0,0,0) != INST_SUCCESS)
            {
               LOG_PRINT(MAJOR,"(Env):No NSVCH Inst found for nsvci - [%d]\n",refId1);
               DalocMsgBuf((I_Void *)rcvPtr);
               return;
            }
            if (lclPidPtr == 0)
            {
               LOG_PRINT(CRITICAL,"(Env):Invalid Instance Found...\n");
               DalocMsgBuf((I_Void *)rcvPtr);
               return ;
            }
            rcvr.LocalPId = (xLocalPIdNode)lclPidPtr;
            S = xGetSignal( sig_PSSKS_NS_NSVCH_NSVC_BLOCK_IND, rcvr, xEnv);
            ((yPDP_sig_PSSKS_NS_NSVCH_NSVC_BLOCK_IND)S)->Param1 = rcvPtr;
            break;

         case PSSKS_NS_NSVCH_NSVC_DOWN_CNF :
            GetNsvchRefId(rcvPtr, &refId1, &refId2);
            LOG_PRINT(INFO,"xInEnv :PSSKS_NS_NSVCH_NSVC_DOWN_CNF received for nsvci - [%d]",refId1);
            if (SearchAlocatedInst(&lclPidPtr,(I_S32*)&instId,ENT_OAMS_PSSCM,NSVCH_CLASS,refId1,refId2,0,0,0) != INST_SUCCESS)
            {
               LOG_PRINT(MAJOR,"(Env):No NSVCH Inst found for nsvci - [%d]\n",refId1);
               DalocMsgBuf((I_Void *)rcvPtr);
               return;
            }
            if (lclPidPtr == 0)
            {
               LOG_PRINT(CRITICAL,"(Env):Invalid Instance Found...\n");
               DalocMsgBuf((I_Void *)rcvPtr);
               return ;
            }
            rcvr.LocalPId = (xLocalPIdNode)lclPidPtr;
            S = xGetSignal( sig_PSSKS_NS_NSVCH_NSVC_DOWN_CNF, rcvr, xEnv);
            ((yPDP_sig_PSSKS_NS_NSVCH_NSVC_DOWN_CNF)S)->Param1 = rcvPtr;
            break;

         case PSSKS_NS_NSVCH_NSVC_UNBLOCK_IND :
            GetNsvchRefId(rcvPtr, &refId1, &refId2);
            LOG_PRINT(INFO,"xInEnv :PSSKS_NS_NSVCH_NSVC_UNBLOCK_IND received for nsvci - [%d]",refId1);
            if (SearchAlocatedInst(&lclPidPtr,(I_S32*)&instId,ENT_OAMS_PSSCM,NSVCH_CLASS,refId1,refId2,0,0,0) != INST_SUCCESS)
            {
               LOG_PRINT(MAJOR,"(Env):No NSVCH Inst found for nsvci - [%d]\n",refId1);
               DalocMsgBuf((I_Void *)rcvPtr);
               return;
            }
            if (lclPidPtr == 0)
            {
               LOG_PRINT(CRITICAL,"(Env):Invalid Instance Found...\n");
               DalocMsgBuf((I_Void *)rcvPtr);
               return ;
            }
            rcvr.LocalPId = (xLocalPIdNode)lclPidPtr;
            S = xGetSignal( sig_PSSKS_NS_NSVCH_NSVC_UNBLOCK_IND, rcvr, xEnv);
            ((yPDP_sig_PSSKS_NS_NSVCH_NSVC_UNBLOCK_IND)S)->Param1 = rcvPtr;
            break;

         case PSSKS_NS_NSVCH_NSVC_BLOCK_CNF :
            GetNsvchRefId(rcvPtr, &refId1, &refId2);
            LOG_PRINT(INFO,"xInEnv :PSSKS_NS_NSVCH_NSVC_BLOCK_CNF received for nsvci - [%d]",refId1);
            if (SearchAlocatedInst(&lclPidPtr,(I_S32*)&instId,ENT_OAMS_PSSCM,NSVCH_CLASS,refId1,refId2,0,0,0) != INST_SUCCESS)
            {
               LOG_PRINT(MAJOR,"(Env):No NSVCH Inst found for nsvci - [%d]\n",refId1);
               DalocMsgBuf((I_Void *)rcvPtr);
               return;
            }
            if (lclPidPtr == 0)
            {
               LOG_PRINT(CRITICAL,"(Env):Invalid Instance Found...\n");
               DalocMsgBuf((I_Void *)rcvPtr);
               return ;
            }
            rcvr.LocalPId = (xLocalPIdNode)lclPidPtr;
            S = xGetSignal( sig_PSSKS_NS_NSVCH_NSVC_BLOCK_CNF, rcvr, xEnv);
            ((yPDP_sig_PSSKS_NS_NSVCH_NSVC_BLOCK_CNF)S)->Param1 = rcvPtr;
            break;

         case PSSKS_NS_NSVCH_NSVC_UNBLOCK_CNF :
            GetNsvchRefId(rcvPtr, &refId1, &refId2);
            LOG_PRINT(INFO,"xInEnv :PSSKS_NS_NSVCH_NSVC_UNBLOCK_CNF received for nsvci - [%d]",refId1);
            if (SearchAlocatedInst(&lclPidPtr,(I_S32*)&instId,ENT_OAMS_PSSCM,NSVCH_CLASS,refId1,refId2,0,0,0) != INST_SUCCESS)
            {
               LOG_PRINT(MAJOR,"(Env):No NSVCH Inst found for nsvci - [%d]\n",refId1);
               DalocMsgBuf((I_Void *)rcvPtr);
               return;
            }
            if (lclPidPtr == 0)
            {
               LOG_PRINT(CRITICAL,"(Env):Invalid Instance Found...\n");
               DalocMsgBuf((I_Void *)rcvPtr);
               return ;
            }
            rcvr.LocalPId = (xLocalPIdNode)lclPidPtr;
            S = xGetSignal( sig_PSSKS_NS_NSVCH_NSVC_UNBLOCK_CNF, rcvr, xEnv);
            ((yPDP_sig_PSSKS_NS_NSVCH_NSVC_UNBLOCK_CNF)S)->Param1 = rcvPtr;
            break;

         case PSSKS_NS_NSVCH_NSVC_RESET_CNF :
            GetNsvchRefId(rcvPtr, &refId1, &refId2);
            LOG_PRINT(INFO,"xInEnv :PSSKS_NS_NSVCH_NSVC_RESET_CNF received for nsvci - [%d]",refId1);
            if (SearchAlocatedInst(&lclPidPtr,(I_S32*)&instId,ENT_OAMS_PSSCM,NSVCH_CLASS,refId1,refId2,0,0,0) != INST_SUCCESS)
            {
               LOG_PRINT(MAJOR,"(Env):No NSVCH Inst found for nsvci - [%d]\n",refId1);
               DalocMsgBuf((I_Void *)rcvPtr);
               return;
            }
            if (lclPidPtr == 0)
            {
               LOG_PRINT(CRITICAL,"(Env):Invalid Instance Found...\n");
               DalocMsgBuf((I_Void *)rcvPtr);
               return ;
            }
            rcvr.LocalPId = (xLocalPIdNode)lclPidPtr;
            S = xGetSignal( sig_PSSKS_NS_NSVCH_NSVC_RESET_CNF, rcvr, xEnv);
            ((yPDP_sig_PSSKS_NS_NSVCH_NSVC_RESET_CNF)S)->Param1 = rcvPtr;
            break;

         case PSSKS_NS_NSVCH_NSVC_RESET_IND :
            GetNsvchRefId(rcvPtr, &refId1, &refId2);
            LOG_PRINT(INFO,"xInEnv :PSSKS_NS_NSVCH_NSVC_RESET_IND received for nsvci - [%d]",refId1);
            if (SearchAlocatedInst(&lclPidPtr,(I_S32*)&instId,ENT_OAMS_PSSCM,NSVCH_CLASS,refId1,refId2,0,0,0) != INST_SUCCESS)
            {
               LOG_PRINT(MAJOR,"(Env):No NSVCH Inst found for nsvci - [%d]\n",refId1);
               DalocMsgBuf((I_Void *)rcvPtr);
               return;
            }
            if (lclPidPtr == 0)
            {
               LOG_PRINT(CRITICAL,"(Env):Invalid Instance Found...\n");
               DalocMsgBuf((I_Void *)rcvPtr);
               return ;
            }

            rcvr.LocalPId = (xLocalPIdNode)lclPidPtr;
            S = xGetSignal( sig_PSSKS_NS_NSVCH_NSVC_RESET_IND, rcvr, xEnv);
            ((yPDP_sig_PSSKS_NS_NSVCH_NSVC_RESET_IND)S)->Param1 = rcvPtr;
            break;
         case PSSKS_NS_NSVCH_ALARM_IND :
			if(((PssksNsNsvchAlarmInd *)(rcvPtr))->sysAlarmId == EVENT_PSSKS_NS_NSVC_UNKNOWN)
			{
			LOG_PRINT(INFO,"xInEnv :Recieved alarmId EVENT_PSSKS_NS_NSVC_UNKNOWN in PSSKS_NS_NSVCH_ALARM_IND message");	
			FILL_SYS_HDR(rcvPtr , OAMS_NSVCH_CFG_ALARM_IND , MSG_SUB_TYPE ,PRCR_PP,ENT_OAMS_PSSCM ,ZERO , PRCR_CP , ENT_OAMS_CFG, ZERO) ;
			if (SendMsg(rcvPtr,MSG_ORD_PRIO,msgSize) == SND_FAIL)
  			{
      			LOG_PRINT(CRITICAL,"(xOutEnv):MESSAGE SENDING FAILED \n");
   			}
   			else
   			{	
      			LOG_PRINT(INFO,"(xOutEnv):Successfully sent message out \n");
   			}
			return ;	
			}
			else
			{
			GetNsvchRefId(rcvPtr, &refId1, &refId2);
            LOG_PRINT(INFO,"xInEnv :PSSKS_NS_NSVCH_ALARM_IND received for nsvci - [%d]",refId1);	
            if (SearchAlocatedInst(&lclPidPtr,(I_S32*)&instId,ENT_OAMS_PSSCM,NSVCH_CLASS,refId1,refId2,0,0,0) != INST_SUCCESS)
            {
               LOG_PRINT(MAJOR,"(Env):No NSVCH Inst found for nsvci - [%d]\n",refId1);
               DalocMsgBuf((I_Void *)rcvPtr);
               return;
            }
            if (lclPidPtr == 0)
            {
               LOG_PRINT(CRITICAL,"(Env):Invalid Instance Found...\n");
               DalocMsgBuf((I_Void *)rcvPtr);
               return ;
            }

            rcvr.LocalPId = (xLocalPIdNode)lclPidPtr;
            S = xGetSignal( sig_PSSKS_NS_NSVCH_ALARM_IND, rcvr, xEnv);
            ((yPDP_sig_PSSKS_NS_NSVCH_ALARM_IND)S)->Param1 = rcvPtr;
			}
            break;


         case PSSKS_FR_NSVCH_N_CONN_IND :
            GetNsvchRefId(rcvPtr, &refId1, &refId2);
            LOG_PRINT(INFO,"xInEnv :PSSKS_FR_NSVCH_N_CONN_IND received for frChannel - [%d]",refId2);
            if (SearchAlocatedInst(&lclPidPtr,(I_S32*)&instId,ENT_OAMS_PSSCM,NSVCH_CLASS,refId1,refId2,0,0,0) != INST_SUCCESS)
            {
               LOG_PRINT(MAJOR,"(Env):No NSVCH Inst found for frChannel - [%d]\n",refId2);
               DalocMsgBuf((I_Void *)rcvPtr);
               return;
            }
            if (lclPidPtr == 0)
            {
               LOG_PRINT(CRITICAL,"(Env):Invalid Instance Found...\n");
               DalocMsgBuf((I_Void *)rcvPtr);
               return ;
            }
            rcvr.LocalPId = (xLocalPIdNode)lclPidPtr;
            S = xGetSignal( sig_PSSKS_FR_NSVCH_N_CONN_IND, rcvr, xEnv);
            ((yPDP_sig_PSSKS_FR_NSVCH_N_CONN_IND)S)->Param1 = rcvPtr;
            break;

         case PSSKS_FR_NSVCH_N_DISC_IND :
            GetNsvchRefId(rcvPtr, &refId1, &refId2);
            LOG_PRINT(INFO,"xInEnv :PSSKS_FR_NSVCH_N_DISC_IND received for frChannel - [%d]",refId2);
            if (SearchAlocatedInst(&lclPidPtr,(I_S32*)&instId,ENT_OAMS_PSSCM,NSVCH_CLASS,refId1,refId2,0,0,0) != INST_SUCCESS)
            {
               LOG_PRINT(MAJOR,"(Env):No NSVCH Inst found for frChannel - [%d]\n",refId2);
               DalocMsgBuf((I_Void *)rcvPtr);
               return;
            }
            if (lclPidPtr == 0)
            {
               LOG_PRINT(CRITICAL,"(Env):Invalid Instance Found...\n");
               DalocMsgBuf((I_Void *)rcvPtr);
               return ;
            }
            rcvr.LocalPId = (xLocalPIdNode)lclPidPtr;
            S = xGetSignal( sig_PSSKS_FR_NSVCH_N_DISC_IND, rcvr, xEnv);
            ((yPDP_sig_PSSKS_FR_NSVCH_N_DISC_IND)S)->Param1 = rcvPtr;
            break;

         case PSSKS_FR_NSVCH_N_STATUS_IND :
            GetNsvchRefId(rcvPtr, &refId1, &refId2);
            LOG_PRINT(INFO,"xInEnv :PSSKS_FR_NSVCH_N_STATUS_IND received for frChannel - [%d]",refId2);
            if (SearchAlocatedInst(&lclPidPtr,(I_S32*)&instId,ENT_OAMS_PSSCM,NSVCH_CLASS,refId1,refId2,0,0,0) != INST_SUCCESS)
            {
               LOG_PRINT(MAJOR,"(Env):No NSVCH Inst found for frChannel - [%d]\n",refId2);
               DalocMsgBuf((I_Void *)rcvPtr);
               return;
            }
            if (lclPidPtr == 0)
            {
               LOG_PRINT(CRITICAL,"(Env):Invalid Instance Found...\n");
               DalocMsgBuf((I_Void *)rcvPtr);
               return ;
            }
            rcvr.LocalPId = (xLocalPIdNode)lclPidPtr;
            S = xGetSignal( sig_PSSKS_FR_NSVCH_N_STATUS_IND, rcvr, xEnv);
            ((yPDP_sig_PSSKS_FR_NSVCH_N_STATUS_IND)S)->Param1 = rcvPtr;
            break;

/* Start of Code changes for mantis 0014053*/
			case PSSKS_FR_NSVCH_N_STOP_CNF :
            GetNsvchRefId(rcvPtr, &refId1, &refId2);
            LOG_PRINT(INFO,"xInEnv :PSSKS_FR_NSVCH_N_STOP_CNF received for frChannel - [%d]",refId2);
            if (SearchAlocatedInst(&lclPidPtr,(I_S32*)&instId,ENT_OAMS_PSSCM,NSVCH_CLASS,refId1,refId2,0,0,0) != INST_SUCCESS)
            {
               LOG_PRINT(MAJOR,"(Env):No NSVCH Inst found for frChannel - [%d]\n",refId2);
               DalocMsgBuf((I_Void *)rcvPtr);
               return;
            }
            if (lclPidPtr == 0)
            {
               LOG_PRINT(CRITICAL,"(Env):Invalid Instance Found...\n");
               DalocMsgBuf((I_Void *)rcvPtr);
               return ;
            }
            rcvr.LocalPId = (xLocalPIdNode)lclPidPtr;
            S = xGetSignal( sig_PSSKS_FR_NSVCH_N_STOP_CNF, rcvr, xEnv);
            ((yPDP_sig_PSSKS_FR_NSVCH_N_STOP_CNF)S)->Param1 = rcvPtr;
            break;
/*End of Code changes for mantis 0014053*/

         case OAMS_CFG_NSVCH_UNLOCK_REQ :
            GetNsvchRefId(rcvPtr, &refId1, &refId2) ;
            LOG_PRINT(INFO,"(Env):OAMS_CFG_NSVCH_UNLOCK_REQ Signal Received from CFG for nsvci - [%d] ",refId1);
            if (ZERO == gInstCount)
            {
               LOG_PRINT(CRITICAL,"(ENV:xInEnv)No NSVCH Found...\n");
               DalocMsgBuf(rcvPtr);
               return ;
            }

            if (SearchAlocatedInst(&lclPidPtr,(I_S32*)&instId,ENT_OAMS_PSSCM,NSVCH_CLASS,refId1,refId2,0,0,0) != INST_SUCCESS)
            {
              if (AlocNewInst(&lclPidPtr,(I_S32*)&instId,ENT_OAMS_PSSCM,NSVCH_CLASS,refId1,refId2,0,0,0) != INST_SUCCESS )
              {
                LOG_PRINT(CRITICAL,"(Env):Unable to create New Instance...\n") ;
                DalocMsgBuf((I_Void *)rcvPtr);
                return ;
              }
              if (lclPidPtr == 0)
              {
                LOG_PRINT(CRITICAL,"(Env):Invalid Instance Found...\n");
                DalocMsgBuf((I_Void *)rcvPtr);
                return ;
              }
            } //if search fails end
            rcvr.LocalPId = (xLocalPIdNode)lclPidPtr;
            S = xGetSignal( sig_OAMS_CFG_NSVCH_UNLOCK_REQ, rcvr, xEnv);
            ((yPDP_sig_OAMS_CFG_NSVCH_UNLOCK_REQ)S)->Param1 = rcvPtr;
            break;

         case OAMS_CFG_NSVCH_LOCK_REQ :
            GetNsvchRefId(rcvPtr, &refId1, &refId2);
            LOG_PRINT(INFO,"xInEnv :OAMS_CFG_NSVCH_LOCK_REQ received for nsvci - [%d]",refId1);
            if (SearchAlocatedInst(&lclPidPtr,(I_S32*)&instId,ENT_OAMS_PSSCM,NSVCH_CLASS,refId1,refId2,0,0,0) != INST_SUCCESS)
            {
               LOG_PRINT(MAJOR,"(Env):No NSVCH Inst found for nsvci - [%d]\n",refId1);
               DalocMsgBuf((I_Void *)rcvPtr);
               return;
            }
            if (lclPidPtr == 0)
            {
               LOG_PRINT(CRITICAL,"(Env):Invalid Instance Found...\n");
               DalocMsgBuf((I_Void *)rcvPtr);
               return ;
            }
            rcvr.LocalPId = (xLocalPIdNode)lclPidPtr;
            S = xGetSignal( sig_OAMS_CFG_NSVCH_LOCK_REQ, rcvr, xEnv);
            ((yPDP_sig_OAMS_CFG_NSVCH_LOCK_REQ)S)->Param1 = rcvPtr;
            break;

         default:
            LOG_PRINT(MAJOR,"Invalid Msg. Rcvd. From Outside(msgTyp = 0x%d) ",((SysHdr *)rcvPtr)->msgType);
            DalocMsgBuf(rcvPtr);
            return;
      }/*End of Switch condition*/
      SDL_Output( S xSigPrioPar(xDefaultPrioSignal), (xIdNode *)0 );
       }
       else
       {
          if (msgType == BPM_SELFCARD_STATE_CHANGE)
          {
           #if BPM_PRESENT != 1
             LOG_PRINT(DEBUG,"(ENV:xInEnv)Locking Semaphore...");
             if( SEM_WAIT(&gSemHandler) !=0)
                   LOG_PRINT(DEBUG,"(ENV:xInEnv)SEM_WAIT failed ");

                LOG_PRINT(DEBUG,"(ENV:xInEnv)BPM_SELFCARD_STATE_CHANGE received ");
             param = (struct sAisParam *)(rcvPtr+sizeof(SysHdr));
             cardStateChangeHandler(param);
             LOG_PRINT(DEBUG,"(ENV:xInEnv)Waiting For Semaphore....");
             if( SEM_TIMED_WAIT(&gSemHandler) != SEMAPHORE_WAIT_COMPLETE)
             {
                   LOG_PRINT(INFO,"(ENV:xInEnv)Got Sempahore.. ");
                   LOG_PRINT(INFO,"(ENV:xInEnv)calling bpmRespondToAis.. ");
                   bpmRespondToAis (param->invocation, OK);
                   LOG_PRINT(INFO,"(ENV:xInEnv)Response sent to BPM.. ");
                   LOG_PRINT(INFO,"(ENV:xInEnv)Releasing Sempahore.. ");
                   SEM_POST(&gSemHandler);
             }
             else
             {
                   LOG_PRINT(INFO,"(ENV:xInEnv)Semaphore Wait Timed Out... ");
                   LOG_PRINT(INFO,"(ENV:xInEnv)Releasing semaphore.. ");
                   SEM_POST(&gSemHandler);
             }
#endif
       }
       else
       {
          LOG_PRINT(DEBUG,"(ENV:xInEnv)Card isn't in Active State , So discarding the received message..... ");
          DalocMsgBuf((I_Void *)rcvPtr) ;
       }
    }
}/*End of If Condition*/


#ifdef XTENV
   return SDL_Time_Lit((xint32)0,(xint32)0);
#endif

}


