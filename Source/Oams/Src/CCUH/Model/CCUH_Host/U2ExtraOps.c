
/* Program generated by Cadvanced 3.0.0.0.2032 */
#define XSCT_CADVANCED

#define C_TRANSLATOR_2_6
#define XENABLE_VERSION_CHECK

#include "scttypes.h"
#include "U2ExtraOps.h"
#ifdef XUSE_SIGNAL_NUMBERS
#include "System_CCUH.hs"
#endif
#ifdef XCTRACE
static char  xFileName[] = "U2ExtraOps.c";
#endif


/*************************************************************************
**                  #CODE directives, #BODY sections                    **
*************************************************************************/
                /* #SDTREF(TEXT,/home1/env/tau3.0/addins/sdlkernels/ADT/u2ExtraOps.pr,491,1) */

#ifdef XSCT_CMICRO
SDL_Integer z_U2ExtraOps_H0O0_numberactive(int PartId)
{
  xInstanceId InstId;
  XCONST_INST xPartTable *PartData;
  int Number = 0;

  PartData = xPartData[PartId];
  for (InstId = 0; InstId < PartData->MaxInstances; InstId++) {
    if (INSTANCE_VAR(InstId)->State != XDORMANT)
      Number++;
  }
  return Number;
}

SDL_PId z_U2ExtraOps_H0O2_getpid(int PartId, SDL_Integer PartIndex)
{
  xInstanceId InstId;
  XCONST_INST xPartTable *PartData;
  int Number = 1;

  PartData = xPartData[PartId];
  for (InstId = 0; InstId < PartData->MaxInstances; InstId++) {
    if (INSTANCE_VAR(InstId)->State != XDORMANT) {
      if (Number == PartIndex)
        return XPID(PartId, InstId);
      Number++;
    }
  }
  return SDL_NULL;
}

#else

static SDL_Boolean xxxSameBlockInstSet(xPrsNode FromP, xPrsNode ToP)
{
  xBlockNode FromBN, ToBN;
  xIdNode FromB, ToB;

  FromB = (xIdNode)FromP->InstNameNode->Parent;
  FromBN = FromP->BlockInst;
  while (FromB != 0) {
    ToB = (xIdNode)ToP->InstNameNode->Parent;
    ToBN = ToP->BlockInst;
    while (ToB != 0) {
      if (FromB == ToB) {
        return (ToBN == FromBN);
      }
      if (ToB->EC == xBlockEC)
        ToBN = ToBN->Container;
      ToB = ToB->Parent;
    }
    if (FromB->EC == xBlockEC)
      FromBN = FromBN->Container;
    FromB = FromB->Parent;
  }
  return SDL_False;
}

static void xxxLocalRemove(xPrsIdNode PrsId, xPrsNode P, xPrsNode Pre)
{
  if (Pre)
    Pre->NextPrs = P->NextPrs;
  else
    *(PrsId->ActivePrsList) = P->NextPrs;

  PrsId = P->TypeNameNode;
  if (! *PrsId->ActivePrsList)
    *PrsId->ActivePrsList = P;
  else {
    Pre = *PrsId->ActivePrsList;
    while (Pre->NextPrs) Pre = Pre->NextPrs;
    Pre->NextPrs = P;
  }
  P->InstNameNode = PrsId;
#ifdef XNRINST
  P->Self.LocalPId->InstNr = P->InstNameNode->NextNr++;
#endif
  return;
}

SDL_Integer z_U2ExtraOps_H0O0_numberactive(xIdNode BlockId, int ContIndex, xPrsNode VarP)
{
  xPrsNode P;
  xPrsIdNode PrsId;
  SDL_Integer Result = 0;
  PrsId = xPrsInst((xIdNode)VarP->InstNameNode, BlockId, ContIndex);
  THREADED_LISTREAD_START
  P = *(((xPrsIdNode)PrsId)->ActivePrsList);
  while (P) {
    if (xxxSameBlockInstSet(VarP, P))
      Result++;
    P = P->NextPrs;
  }
  THREADED_LISTACCESS_END
  return Result;
}

SDL_Integer z_U2ExtraOps_H0O1_numberactive2(xIdNode PrsId)
{
  xPrsNode P;
  SDL_Integer Result = 0;
  THREADED_LISTREAD_START
  P = *(((xPrsIdNode)PrsId)->ActivePrsList);
  while (P) {
    P = P->NextPrs;
    Result++;
  }
  THREADED_LISTACCESS_END
  return Result;
}

SDL_PId z_U2ExtraOps_H0O2_getpid(xIdNode BlockId, int ContIndex, xPrsNode VarP, SDL_Integer PrsIndex)
{
  xPrsNode P;
  xPrsIdNode PrsId;
  if (PrsIndex <= 0) return SDL_NULL;
  PrsId = xPrsInst((xIdNode)VarP->InstNameNode, BlockId, ContIndex);
  THREADED_LISTREAD_START
  P = *(((xPrsIdNode)PrsId)->ActivePrsList);
  while (P && (PrsIndex>1)) {
    if (xxxSameBlockInstSet(VarP, P))
      PrsIndex--;
    P = P->NextPrs;
  }
  while (P && !xxxSameBlockInstSet(VarP, P)) {
    P = P->NextPrs;
  }
  THREADED_LISTACCESS_END
  if (P) return P->Self;
  return SDL_NULL;
}

SDL_PId z_U2ExtraOps_H0O3_getpid2(xIdNode PrsId, SDL_Integer PrsIndex)
{
  xPrsNode P;
  if (PrsIndex <= 0) return SDL_NULL;
  THREADED_LISTREAD_START
  P = *(((xPrsIdNode)PrsId)->ActivePrsList);
  while (P && (PrsIndex>1)) {
    P = P->NextPrs;
    PrsIndex--;
  }
  THREADED_LISTACCESS_END
  if (P) return P->Self;
  return SDL_NULL;
}

SDL_PId z_U2ExtraOps_H0O4_getpidbl(xPrsNode VarP, xIdNode BlockId, ...)
{
  va_list ap;
  xPrsNode P;
  xIdNode PrsId;
  int Index;
  xBlockNode BN, BN2;

  va_start(ap, BlockId);
  Index = va_arg(ap, int);
  BN = VarP->BlockInst;
  while (Index>=0) {
    if (BlockId->EC == xBlockTypeEC) {
      BlockId = (xIdNode)xPrsInst((xIdNode)VarP->InstNameNode, BlockId, Index);
    } else {
      BlockId = ((xBlockIdNode)BlockId)->Contents[Index];
    }
    Index = va_arg(ap, int);
    BN2 = ((xBlockIdNode)BlockId)->ActiveBlockList->Suc;
    while (BN2 != ((xBlockIdNode)BlockId)->ActiveBlockList) {
      if (!BN || (BN2->Container == BN)) Index--;
      if (Index == 0) {
        BN = BN2;
        break;
      }
      BN2 = BN2->Suc;
    }
    Index = va_arg(ap, int);
  }
  va_end(ap);

  PrsId = (xIdNode)((xBlockIdNode)BlockId)->BlockProcess;
  THREADED_LISTREAD_START
  P = *(((xPrsIdNode)PrsId)->ActivePrsList);
  while (P) {
    if (xxxSameBlockInstSet(VarP, P)) break;
    P = P->NextPrs;
  }
  THREADED_LISTACCESS_END
  if (P) return P->Self;
  return SDL_NULL;
}

SDL_PId z_U2ExtraOps_H0O5_getpidbl2(xIdNode BlockId, SDL_Integer BlockIndex)
{
  xPrsNode P;
  xIdNode PrsId;
  PrsId = (xIdNode)((xBlockIdNode)BlockId)->BlockProcess;
  THREADED_LISTREAD_START
  P = *(((xPrsIdNode)PrsId)->ActivePrsList);
  while (P && (--BlockIndex>0))
    P = P->NextPrs;
  THREADED_LISTACCESS_END
  if (P) return P->Self;
  return SDL_NULL;
}

SDL_Boolean z_U2ExtraOps_H0O6_isa(SDL_Pid PI, xPrsIdNode PT)
{
  xPrsIdNode PrsId;
  if (xEq_SDL_PId_NULL(PI)) return SDL_False;
  PrsId = PI.LocalPId->PrsP->TypeNameNode;
  while (PrsId) {
    if (PrsId == PT) return SDL_True;
    PrsId = PrsId->Super;
  }
  return SDL_False;
}

void z_U2ExtraOps_H0O8_appendpid(SDL_Pid PI, xIdNode BlockId, int ContIndex, xPrsNode VarP)
{
  xPrsNode *Temp;
  xPrsNode  P, tmp;
  xPrsIdNode PrsId;
  xBlockNode BN;

  if (xEq_SDL_PId_NULL(PI)) return;
  P = PI.LocalPId->PrsP;
  if (VarP->InstNameNode->EC != xProcessTypeEC) {
    PrsId = xPrsInst((xIdNode)VarP->InstNameNode, BlockId, ContIndex);
    BN = VarP->BlockInst;
  } else if (P->InstNameNode->EC != xProcessTypeEC) {
    PrsId = xPrsInst((xIdNode)P->InstNameNode, BlockId, ContIndex);
    BN = P->BlockInst;
  } else {
    return;
  }
  if (!z_U2ExtraOps_H0O6_isa(PI, PrsId->Super))
    return;
  THREADED_LISTWRITE_START
  if ( (PrsId->MaxNoOfInst != -1) &&
       (xNoOfActivePrs(PrsId, BN) >= PrsId->MaxNoOfInst) ) {
    THREADED_LISTACCESS_END
    return;
  }
  Temp = P->InstNameNode->ActivePrsList;
  if ((*Temp) == P)
    (*Temp) = (*Temp)->NextPrs;
  else {
    while ((*Temp)->NextPrs != P)
      Temp = &(*Temp)->NextPrs;
    (*Temp)->NextPrs = P->NextPrs;
  }
  if (! *PrsId->ActivePrsList)
    *PrsId->ActivePrsList = P;
  else {
    tmp = *PrsId->ActivePrsList;
    while (tmp->NextPrs) tmp = tmp->NextPrs;
    tmp->NextPrs = P;
  }
  P->InstNameNode = PrsId;
#ifdef XNRINST
  P->Self.LocalPId->InstNr = P->InstNameNode->NextNr++;
#endif
  xDecBlockRef(P->BlockInst);
  P->BlockInst = BN;
  BN->RefCounter--;
  THREADED_LISTACCESS_END
}

void z_U2ExtraOps_H0O9_appendpid2(SDL_Pid PI, xIdNode PrsId)
{
  xPrsNode *Temp;
  xPrsNode  P, tmp;
  if (xEq_SDL_PId_NULL(PI)) return;
  P = PI.LocalPId->PrsP;
  if (!z_U2ExtraOps_H0O6_isa(PI, ((xPrsIdNode)PrsId)->Super))
    return;
  THREADED_LISTWRITE_START
  if ( (((xPrsIdNode)PrsId)->MaxNoOfInst != -1) &&
       (xNoOfActivePrs((xPrsIdNode)PrsId, xFindBlockNode(PrsId, P)) >=
        ((xPrsIdNode)PrsId)->MaxNoOfInst) ) {
    THREADED_LISTACCESS_END
    return;
  }
  Temp = P->InstNameNode->ActivePrsList;
  if ((*Temp) == P)
    (*Temp) = (*Temp)->NextPrs;
  else {
    while ((*Temp)->NextPrs != P)
      Temp = &(*Temp)->NextPrs;
    (*Temp)->NextPrs = P->NextPrs;
  }
  if (! *((xPrsIdNode)PrsId)->ActivePrsList)
    *((xPrsIdNode)PrsId)->ActivePrsList = P;
  else {
    tmp = *((xPrsIdNode)PrsId)->ActivePrsList;
    while (tmp->NextPrs) tmp = tmp->NextPrs;
    tmp->NextPrs = P;
  }
  P->InstNameNode = (xPrsIdNode)PrsId;
#ifdef XNRINST
  P->Self.LocalPId->InstNr = P->InstNameNode->NextNr++;
#endif
  THREADED_LISTACCESS_END
}

void z_U2ExtraOps_H0OA_removepid(xIdNode BlockId, int ContIndex, xPrsNode VarP, SDL_Integer PrsIndex)
{
  xPrsNode P, tmp;
  xPrsIdNode PrsId;
  if (PrsIndex <= 0) return;
  PrsId = xPrsInst((xIdNode)VarP->InstNameNode, BlockId, ContIndex);
  THREADED_LISTREAD_START
  P = *(((xPrsIdNode)PrsId)->ActivePrsList);
  tmp = 0;
  while (P && (PrsIndex>1)) {
    if (xxxSameBlockInstSet(VarP, P))
      PrsIndex--;
    tmp = P;
    P = P->NextPrs;
  }
  while (P && !xxxSameBlockInstSet(VarP, P)) {
    tmp = P;
    P = P->NextPrs;
  }
  if (!P) {
    THREADED_LISTACCESS_END
    return;
  }
  xxxLocalRemove(PrsId, P, tmp);
  THREADED_LISTACCESS_END
  return;
}

void z_U2ExtraOps_H0OB_removepid2(xIdNode PrsId, SDL_Integer PrsIndex)
{
  xPrsNode P, tmp;
  if (PrsIndex <= 0) return;
  THREADED_LISTREAD_START
  P = *(((xPrsIdNode)PrsId)->ActivePrsList);
  tmp = 0;
  while (P && (PrsIndex>1)) {
    tmp = P;
    P = P->NextPrs;
    PrsIndex--;
  }
  if (!P) {
    THREADED_LISTACCESS_END
    return;
  }
  xxxLocalRemove((xPrsIdNode)PrsId, P, tmp);
  THREADED_LISTACCESS_END
  return;
}

void z_U2ExtraOps_H0OC_removepidvalue(xIdNode BlockId, int ContIndex, xPrsNode VarP, SDL_Pid PI)
{
  xPrsNode P, tmp;
  xPrsIdNode PrsId;
  if (xEq_SDL_PId_NULL(PI)) return;
  PrsId = xPrsInst((xIdNode)VarP->InstNameNode, BlockId, ContIndex);
  THREADED_LISTREAD_START
  P = *(((xPrsIdNode)PrsId)->ActivePrsList);
  tmp = 0;
  while (P && (P != PI.LocalPId->PrsP)) {
    tmp = P;
    P = P->NextPrs;
  }
  if (!P || !xxxSameBlockInstSet(VarP, P)) {
    THREADED_LISTACCESS_END
    return;
  }
  xxxLocalRemove(PrsId, P, tmp);
  THREADED_LISTACCESS_END
  return;
}

void z_U2ExtraOps_H0OD_removepidvalue2(xIdNode PrsId, SDL_Pid PI)
{
  xPrsNode P, tmp;
  if (xEq_SDL_PId_NULL(PI)) return;
  THREADED_LISTREAD_START
  P = *(((xPrsIdNode)PrsId)->ActivePrsList);
  tmp = 0;
  while (P && (P != PI.LocalPId->PrsP)) {
    tmp = P;
    P = P->NextPrs;
  }
  if (!P) {
    THREADED_LISTACCESS_END
    return;
  }
  xxxLocalRemove((xPrsIdNode)PrsId, P, tmp);
  THREADED_LISTACCESS_END
  return;
}
#endif


/*************************************************************************
**                  SECTION Variables and Functions                     **
*************************************************************************/

/*****
* PACKAGE U2ExtraOps
* #SDTREF(TEXT,/home1/env/tau3.0/addins/sdlkernels/ADT/u2ExtraOps.pr,27,9)
******/
XCONST struct xPackageIdStruct yPacR_z_U2ExtraOps__U2ExtraOps = {xPackageEC
  xSymbTLink((xIdNode)0, (xIdNode)0), (xIdNode)&xSymbolTableIdRec
  xIdNames("U2ExtraOps") xIdNumber(0) XCOMMON_EXTRAS xIdNames(0) XPAC_EXTRAS};

/*************************************************************************
**                       SECTION Initialization                         **
*************************************************************************/
void yInit_U2ExtraOps (void)
{
  static int IsCalled = 0;
  int  Temp;
  YINIT_TEMP_VARS
  if (IsCalled) {
    return;
  }
  IsCalled = 1;
  xInsertIdNode((xIdNode)&yPacR_z_U2ExtraOps__U2ExtraOps);
}
